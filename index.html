<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>နေ့စဉ်မှတ်တမ်း</title>
    <!-- Tailwind CSS CDN (အင်တာနက်ချိတ်ဆက်မှု လိုအပ်ပါသည်) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyidaungsu Font via Google Fonts (အင်တာနက်ချိတ်ဆက်မှု လိုအပ်ပါသည်) -->
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles (ဤအပိုင်းက အင်တာနက်မလိုပါ) */
        :root {
            --primary-color: #1e40af;
            --primary-hover: #1d4ed8;
            --secondary-color: #6b7280;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --modal-background: rgba(0, 0, 0, 0.5);
        }
        /* ကျန်တဲ့ CSS ကို ပုံမှန်အတိုင်း ထားပါတယ် (အပေါ်က ကုဒ်ကနေ ကူးယူပါ) */
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="text-4xl font-bold text-center text-blue-800 mb-8">နေ့စဉ်မှတ်တမ်း</h1>
            
            <!-- Main Content Area -->
            <div id="app-content" role="main">
                <!-- Privacy Policy Section -->
                <div id="privacySection" class="section hidden" aria-labelledby="privacy-title">
                    <h2 id="privacy-title" class="text-2xl font-bold text-center text-orange-700 mb-6">ကိုယ်ရေးအချက်အလက်ကာကွယ်မှု</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App သည် သုံးစွဲသူများ၏ ကိုယ်ရေးအချက်အလက် လုံခြုံရေးကို အလေးထားပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ အချက်အလက်သိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>သင့်၏ ဂျာနယ်မှတ်တမ်းများကို သင့် Browser ၏ Local Storage တွင်သာ သိမ်းဆည်းထားပါသည်။</li>
                                <li>မည်သည့် Server သို့မှ အချက်အလက်မျှ ပေးပို့ခြင်းမရှိပါ။</li>
                                <li>၎င်းသည် သင့်အချက်အလက်များကို သင့်ထိန်းချုပ်မှုအောက်တွင်သာ ရှိစေပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်ဖောက်ပြားမှု ကာကွယ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>အချက်အလက်များ Local Storage တွင်သာ ရှိသောကြောင့် ပြင်ပ Server များမှ ပေါက်ကြားနိုင်ခြေ မရှိပါ။</li>
                                <li>Browser Cache ရှင်းလင်းပါက မှတ်တမ်းများ ပျောက်ဆုံးနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ပြင်ပဝန်ဆောင်မှုများ</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Google Gemini API ကို သုံးသပ်ချက်ရယူရန်အတွက်သာ အသုံးပြုပါသည်။</li>
                                <li>သင့်ကိုယ်ရေးအချက်အလက်များကို သိမ်းဆည်းခြင်း မရှိပါ။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreePrivacyBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- Terms Section -->
                <div id="termsSection" class="section hidden" aria-labelledby="terms-title">
                    <h2 id="terms-title" class="text-2xl font-bold text-center text-yellow-700 mb-6">စည်းမျဉ်းနှင့် သတ်မှတ်ချက်များ</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App ကို အသုံးပြုခြင်းဖြင့် အောက်ပါ စည်းမျဉ်းများကို သဘောတူညီရာ ရောက်ပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ App အသုံးပြုခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ကိုယ်ပိုင် ဂျာနယ်မှတ်တမ်းရေးသားခြင်းအတွက်သာ အသုံးပြုရပါမည်။</li>
                                <li>မလျော်ကန်သော နည်းလမ်းများဖြင့် အသုံးပြုခြင်းကို တားမြစ်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်များ</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>မှတ်တမ်းများ ပျောက်ဆုံးခြင်းအတွက် App ဖန်တီးသူတွင် တာဝန်မရှိပါ။</li>
                                <li>အရေးကြီးသော မှတ်တမ်းများကို Backup လုပ်ထားရန် အကြံပြုပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ဝန်ဆောင်မှု</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ဤ App ကို "ရှိပြီးသားအတိုင်း" ပေးထားခြင်းဖြစ်ပြီး မည်သည့် အာမခံချက်မျှ မရှိပါ။</li>
                                <li>လုပ်ဆောင်ချက်များ အချိန်မရွေး ပြောင်းလဲနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreeTermsBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- User Guide Section -->
                <div id="guideSection" class="section hidden" aria-labelledby="guide-title">
                    <h2 id="guide-title" class="text-2xl font-bold text-center text-blue-700 mb-6">အသုံးပြုနည်းလမ်းညွှန်</h2>
                    <div class="space-y-6 text-gray-700">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ ဂျာနယ်စတင်ရေးသားခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>လက်ရှိရက်စွဲကို အလိုအလျောက် သတ်မှတ်ပေးထားပါသည်။</li>
                                <li>စိတ်ခံစားမှုကို ရွေးချယ်ပြီး "မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်" ကို နှိပ်ပါ။</li>
                                <li>မေးခွန်းတစ်ခုချင်းစီကို ဖြေကြားပြီး "နောက်မေးခွန်း" သို့ ရွှေ့ပါ။</li>
                                <li>ဖုန်းတွင် နှိပ်ရုံဖြင့်လည်း နောက်မေးခွန်းသို့ ရွှေ့နိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ မှတ်တမ်းသိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"အဖြေများ စုစည်းမည်" ကို နှိပ်လျှင် အလိုအလျောက် သိမ်းဆည်းပါသည်။</li>
                                <li>AI သုံးသပ်ချက်အချို့အရ အားပေးစကားများကို ထုတ်ပေးပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ Export လုပ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"Notion Markdown ထုတ်မည်" ကို နှိပ်ပြီး Markdown ဖိုင်ကို ရယူနိုင်ပါသည်။</li>
                                <li>ထိုဖိုင်ကို Notion သို့ Drag & Drop ဖြင့် တင်သွင်းနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="startJournalingBtn" class="btn btn-primary" aria-label="ဂျာနယ်စတင်ရေးမည်">ဂျာနယ်စတင်ရေးမည်</button>
                    </div>
                </div>

                <!-- API Key Input Section -->
                <div id="apiKeySection" class="section hidden" aria-labelledby="api-key-title">
                    <h2 id="api-key-title" class="text-2xl font-bold text-center text-blue-700 mb-6">Gemini API Key</h2>
                    <div class="space-y-4">
                        <p class="text-gray-600">သင်၏ဂျာနယ်မှတ်တမ်းများကို AI ဖြင့် သုံးသပ်ရန်အတွက် Google Gemini API Key လိုအပ်ပါသည်။</p>
                        <p class="text-sm text-gray-500">API Key ကို <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a> မှ ရယူနိုင်ပါသည်။</p>
                        <input type="password" id="apiKeyInput" class="input-field" placeholder="Enter your Gemini API Key" aria-label="Gemini API Key" required>
                        <div class="text-center">
                            <button id="saveApiKeyBtn" class="btn btn-primary" aria-label="သိမ်းမည်">သိမ်းမည်</button>
                        </div>
                    </div>
                </div>

                <!-- Main Journal Section -->
                <div id="journalSection" class="section hidden">
                    <!-- Date and Mood Selection -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="journalDate" class="block text-gray-700 font-medium mb-2">ရက်စွဲ:</label>
                            <input type="date" id="journalDate" class="input-field" aria-label="ရက်စွဲ ရွေးပါ" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">စိတ်ခံစားမှု:</label>
                            <select id="journalMood" class="input-field" aria-label="စိတ်ခံစားမှု ရွေးပါ" required>
                                <option value="">စိတ်ခံစားမှု ရွေးပါ</option>
                                <option value="ပျော်ရွှင်">ပျော်ရွှင် 😊</option>
                                <option value="ဝမ်းနည်း">ဝမ်းနည်း 😢</option>
                                <option value="စိတ်တို">စိတ်တို 😠</option>
                                <option value="စိတ်လှုပ်ရှား">စိတ်လှုပ်ရှား 🤩</option>
                                <option value="ငြိမ်သက်">ငြိမ်သက် 😌</option>
                                <option value="ပင်ပန်း">ပင်ပန်း 😴</option>
                                <option value="စိတ်ရှုပ်">စိတ်ရှုပ် 😕</option>
                                <option value="ကျေနပ်">ကျေနပ် 👍</option>
                            </select>
                        </div>
                    </div>

                    <!-- Life Reflection Philosophy -->
                    <div class="mt-6 bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h3 class="text-lg font-semibold text-blue-900">ဘဝဆိုင်ရာ တွေးတောမှု</h3>
                        <p id="philosophyText" class="text-blue-700"></p>
                        <p id="sourceCredit" class="text-xs text-blue-600 mt-2"></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="startPromptsBtn" class="btn btn-primary">
                            <span id="startPromptsBtnText">✨ မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်</span>
                        </button>
                        <button id="clearApiKeyBtn" class="btn btn-danger">API Key ဖယ်ရှားမည်</button>
                    </div>

                    <!-- Feedback Form -->
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">အကြံပြုချက်</h3>
                        <textarea id="feedbackTextarea" class="input-field textarea-field" placeholder="သင်၏ အကြံပြုချက်များကို ဤနေရာတွင် ရေးပါ" aria-label="အကြံပြုချက်"></textarea>
                        <div class="text-center mt-4">
                            <button id="submitFeedbackBtn" class="btn btn-success" aria-label="အကြံပြုချက် ပေးပို့မည်">အကြံပြုချက် ပေးပို့မည်</button>
                        </div>
                    </div>
                </div>

                <!-- Prompts Section -->
                <div id="promptsSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">ဂျာနယ်မေးခွန်းများ</h2>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="promptDisplay" class="prompt-display">
                        <p id="currentPromptText" class="text-lg font-medium text-blue-900 mb-4"></p>
                        <textarea id="promptAnswerTextarea" class="input-field textarea-field" placeholder="သင့်အဖြေကို ဤနေရာတွင် ရေးပါ" aria-label="မေးခွန်းအတွက် အဖြေ"></textarea>
                    </div>
                    <div class="flex justify-between gap-4">
                        <button id="prevPromptBtn" class="btn btn-secondary" disabled aria-label="ယခင်မေးခွန်း">ယခင်မေးခွန်း</button>
                        <span id="promptCounter" class="text-gray-600 self-center" aria-live="polite">1/5</span>
                        <button id="nextPromptBtn" class="btn btn-primary" aria-label="နောက်မေးခွန်း">နောက်မေးခွန်း</button>
                        <button id="combineAnswersBtn" class="btn btn-success hidden" aria-label="အဖြေများ စုစည်းမည်">အဖြေများ စုစည်းမည်</button>
                    </div>
                    <div class="text-center mt-6">
                        <button id="backToJournalBtn" class="btn btn-secondary" aria-label="ပင်မစာမျက်နှာသို့ ပြန်သွားမည်">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>

                <!-- Suggestions Section -->
                <div id="suggestionsSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">အကြံပြုချက်များ</h2>
                    <div id="affirmationDisplay" class="suggestion-card">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အားပေးစကား</h3>
                        <p id="affirmationText" class="text-gray-700"></p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ဂျာနယ်မှတ်တမ်း</h3>
                        <textarea id="combinedJournalText" class="input-field textarea-field" style="min-height: 300px;" readonly aria-label="ဂျာနယ်မှတ်တမ်း"></textarea>
                        <div class="flex justify-center gap-4 mt-4">
                            <button id="copyCombinedTextBtn" class="btn btn-success" aria-label="အားလုံးကူးယူမည်">အားလုံးကူးယူမည်</button>
                            <button id="exportToNotionBtn" class="btn btn-primary" aria-label="Notion Markdown ထုတ်မည်">Notion Markdown ထုတ်မည်</button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button id="backToMainJournalBtn" class="btn btn-secondary" aria-label="ပင်မစာမျက်နှာသို့ ပြန်သွားမည်">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
            <div class="modal-content">
                <button id="modalClose" class="modal-close" aria-label="ပိတ်မည်">×</button>
                <p id="modalMessage" class="text-center font-semibold"></p>
            </div>
        </div>
    </div>

    <script>
        // Fallback affirmations for different moods
        const FALLBACK_AFFIRMATIONS = {
            "ပျော်ရွှင်": [
                "သင့်ရဲ့ ပျော်ရွှင်မှုကို ဆက်လက်မျှဝေပြီး အခြားသူတွေကိုလည်း အားပေးပါ။",
                "ဒီပျော်ရွှင်မှုကို အမှတ်တရအဖြစ် သိမ်းထားပြီး နောက်ထပ်ထပ်ဖန်တီးပါ။"
            ],
            "ဝမ်းနည်း": [
                "သင်တစ်ယောက်တည်း မဟုတ်ပါဘူး။ စိတ်ခံစားမှုတွေကို လွတ်လပ်စွာ ဖော်ပြပြီး အားယူပါ။",
                "ဒီနေ့ သင့်ကိုယ်သင် ဂရုစိုက်ဖို့ အချိန်ပေးပါ။ အနည်းငယ်အနားယူခြင်းက အထောက်အကူပြုနိုင်ပါတယ်။"
            ],
            "စိတ်တို": [
                "စိတ်အေးအေးထားပြီး အသက်ရှူလေ့ကျင့်ခန်း လုပ်ကြည့်ပါ။ သင်ရဲ့စိတ်ကို ပြန်လည်ထိန်းချုပ်နိုင်ပါတယ်။",
                "သင့်ရဲ့စိတ်တိုမှုကို ရေးထုတ်ပြီး ဘာကြောင့်ဖြစ်ပေါ်လာလဲ ဆန်းစစ်ကြည့်ပါ။"
            ],
            "စိတ်လှုပ်ရှား": [
                "ဒီစိတ်လှုပ်ရှားမှုကို အသုံးချပြီး သင့်ရဲ့ရည်မှန်းချက်တွေကို အကောင်အထည်ဖော်ပါ။",
                "ဒီစိတ်လှုပ်ရှားမှုကို အခြားသူတွေနဲ့ မျှဝေပြီး အကောင်းမြင်စိတ်ကို ဖြန့်ဝေပါ။"
            ],
            "ငြိမ်သက်": [
                "ဒီငြိမ်သက်မှုကို ဆက်လက်ထိန်းသိမ်းပြီး သင့်ရဲ့စိတ်ကို အာရုံစူးစိုက်မှု ပေးပါ။",
                "ဒီအခိုက်အတန့်ကို အပြည့်အဝခံစားပြီး ကိုယ့်ကိုယ်ကို အားဖြည့်ပါ။"
            ],
            "ပင်ပန်း": [
                "သင့်ကိုယ်သင် အနားပေးဖို့ အချိန်ယူပါ။ အနည်းငယ်အနားယူခြင်းက အံ့သြဖွယ်ဖြစ်စေနိုင်ပါတယ်။",
                "ဒီနေ့ သင်လုပ်ဆောင်ခဲ့တာတွေကို ဂုဏ်ယူပြီး အနားယူဖို့ အချိန်ပေးပါ။"
            ],
            "စိတ်ရှုပ်": [
                "အသက်ရှူလေ့ကျင့်ခန်း လုပ်ပြီး သင့်ရဲ့အတွေးတွေကို စီစဉ်ကြည့်ပါ။",
                "သင့်ရဲ့စိတ်ရှုပ်မှုကို တစ်ခုချင်း ဖြေရှင်းဖို့ အသေးစိတ်စီစဉ်ပါ။"
            ],
            "ကျေနပ်": [
                "ဒီကျေနပ်မှုကို ဆက်လက်ထိန်းသိမ်းပြီး နောက်ထပ်အောင်မြင်မှုတွေကို ဖန်တီးပါ။",
                "သင့်ရဲ့အောင်မြင်မှုတွေကို ဂုဏ်ယူပြီး နောက်ထပ်ပန်းတိုင်တွေ ချမှတ်ပါ။"
            ]
        };

        // Utility module for localStorage operations
        const StorageUtil = {
            save(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Error saving ${key}: ${e.message}`);
                    return false;
                }
            },
            load(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error(`Error loading ${key}: ${e.message}`);
                    return null;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error(`Error removing ${key}: ${e.message}`);
                    return false;
                }
            }
        };

        // API module for Gemini API interactions
        const GeminiAPI = {
            async fetchPrompts(mood, apiKey) {
                const prompt = mood
                    ? `Generate 5 distinct journaling prompts in Burmese, suitable for someone experiencing a '${mood}' mood. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`
                    : `Generate 5 journaling prompts in Burmese. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`;
                return this._makeApiCall(prompt, { type: 'ARRAY', items: { type: 'STRING' } }, apiKey, "gemini-2.0-flash");
            },
            async fetchAffirmation(journalText, mood, apiKey) {
                const prompt = `Analyze the following journal entry in Burmese:\n\n${journalText}\n\nMood: ${mood}\n\nProvide a positive affirmation in Burmese based on the journal entry and mood. The affirmation should be motivational, concise, and relevant. Return a JSON response: {"affirmation": "A positive affirmation in Burmese."}`;
                return this._makeApiCall(prompt, {
                    type: 'OBJECT',
                    properties: { affirmation: { type: 'STRING' } },
                    required: ['affirmation']
                }, apiKey, "gemini-2.0-flash");
            },
            async _makeApiCall(prompt, schema, apiKey, model = "gemini-2.0-flash", responseMimeType = "application/json") {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
                const payload = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: schema ? { responseMimeType: responseMimeType, responseSchema: schema } : { responseMimeType: responseMimeType },
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                        ]
                    })
                };
                try {
                    const response = await fetch(apiUrl, payload);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMsg = errorData?.error?.message || response.statusText;
                        if (response.status === 403) {
                            throw new Error(`API Key မှားယွင်းနေပါသည်။ ကျေးဇူးပြု၍ Google AI Studio[](https://aistudio.google.com/app/apikey) မှ မှန်ကန်သော API Key ကို ထည့်သွင်းပေးပါ။`);
                        } else if (response.status === 429) {
                            throw new Error(`သင့် API အသုံးပြုမှု ကန့်သတ်ချက် ပြည့်နေပါပြီ။ ကျေးဇူးပြု၍ Google AI Studio[](https://aistudio.google.com/app/apikey) တွင် သင့် Plan နှင့် Billing အချက်အလက်များကို စစ်ဆေးပါ။`);
                        } else if (response.status === 503) {
                            throw new Error(`AI Model အလုပ်များနေပါသည်။ ခဏစောင့်ပြီး ပြန်လည်ကြိုးစားကြည့်ပါ။`);
                        } else {
                            throw new Error(`API ချိတ်ဆက်မှု ပြဿနာရှိခဲ့ပါသည်။ Status: ${response.status} ${errorMsg}`);
                        }
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return JSON.parse(result.candidates[0].content.parts[0].text);
                    }
                    throw new Error('Unexpected API response structure.');
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        };

        // Suggestion module for generating affirmations
        const SuggestionModule = {
            async generateAffirmation(journalText, mood, apiKey) {
                if (!journalText || journalText.trim() === "") {
                    return { affirmation: null, error: "ဂျာနယ်မှတ်တမ်း ဗလာဖြစ်နေပါသည်။" };
                }
                try {
                    const result = await GeminiAPI.fetchAffirmation(journalText, mood, apiKey);
                    return { affirmation: result.affirmation, error: null };
                } catch (error) {
                    console.error("Error generating affirmation:", error);
                    const fallback = FALLBACK_AFFIRMATIONS[mood]?.[Math.floor(Math.random() * FALLBACK_AFFIRMATIONS[mood].length)] || "သင့်ကိုယ်သင် ယုံကြည်မှုထားပါ၊ သင်သည် အရာအားလုံးကို ကျော်လွှားနိုင်ပါသည်။";
                    return { affirmation: fallback, error: error.message };
                }
            }
        };

        // UI utility module
        const UIUtil = {
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    setTimeout(() => targetSection.classList.add('active'), 50);
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                    targetSection.focus();
                }
            },
            showModal(message, type = 'success') {
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modalMessage');
                modalMessage.textContent = message;
                modal.className = `modal show ${type}`;
                modal.focus();
                setTimeout(() => this.hideModal(), 3000);
            },
            hideModal() {
                const modal = document.getElementById('modal');
                modal.classList.remove('show', 'success', 'error');
            },
            setLoading(element, isLoading, originalText = '', spinnerHtml = '<span class="loading-spinner"></span>') {
                if (isLoading) {
                    element.disabled = true;
                    element.innerHTML = spinnerHtml + originalText;
                } else {
                    element.disabled = false;
                    element.innerHTML = originalText;
                }
            },
            updateProgressBar(current, total) {
                const progressBar = document.getElementById('progressBar');
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            }
        };

        // Main Journal App Class
        class JournalApp {
            constructor() {
                this.currentPromptIndex = 0;
                this.promptAnswers = [];
                this.activePrompts = [];
                this.defaultPrompts = [
                    "ဒီနေ့အတွက် ကျေးဇူးတင်စရာ ဘာတွေရှိလဲ။",
                    "ဒီနေ့ ဘယ်အရာက သင့်ကို ပျော်ရွှင်စေခဲ့လဲ။",
                    "ဒီနေ့ သင်ယူခဲ့ရတဲ့ အရာတစ်ခုခု ရှိလား။",
                    "ဒီနေ့ ဘယ်လို စိတ်ခံစားမှုမျိုး ခံစားခဲ့ရလဲ။ ဘာကြောင့်လဲ။",
                    "ကိုယ့်ကိုယ်ကို ပိုကောင်းအောင် ဘာတွေ လုပ်နိုင်ခဲ့လဲ။"
                ];
                this.isLoading = false;
                this.philosophyTexts = [
                    {
                        text: "တစ်နေ့တာ ၁၀ မိနစ်လောက် ကိုယ့်ကိုယ်ကို ပြန်သုံးသပ်တဲ့အချိန်ပေးတာက ဘဝတိုးတက်ဖို့အတွက် အရေးကြီးဆုံးအရာတွေထဲက တစ်ခုပါပဲ။",
                        credit: "Credit: KO LAPYAE"
                    },
                    {
                        text: "နေ့စဉ် ဂျာနယ်ရေးသားခြင်းသည် မိမိကိုယ်ကို ပိုမိုနားလည်စေပြီး စိတ်ဖိစီးမှုများကို လျှော့ချကာ စိတ်ပိုင်းဆိုင်ရာ ကျန်းမာရေးကို မြှင့်တင်ပေးသည်။",
                        credit: "Source: Journaling for Mental Health"
                    }
                ];
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkInitialState();
                this.displayRandomPhilosophy();
            }

            bindEvents() {
                document.getElementById('agreePrivacyBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToPrivacy', 'true');
                    UIUtil.showSection('termsSection');
                });
                document.getElementById('agreeTermsBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToTerms', 'true');
                    UIUtil.showSection('guideSection');
                });
                document.getElementById('startJournalingBtn').addEventListener('click', () => this.promptForApiKeyOrStartJournaling());
                document.getElementById('saveApiKeyBtn').addEventListener('click', () => this.saveApiKey());
                document.getElementById('clearApiKeyBtn').addEventListener('click', () => this.clearApiKey());
                document.getElementById('startPromptsBtn').addEventListener('click', () => this.startPrompts());
                document.getElementById('submitFeedbackBtn').addEventListener('click', () => this.submitFeedback());
                document.getElementById('prevPromptBtn').addEventListener('click', () => this.previousPrompt());
                document.getElementById('nextPromptBtn').addEventListener('click', () => this.nextPrompt());
                document.getElementById('combineAnswersBtn').addEventListener('click', () => this.combineAnswers());
                document.getElementById('backToJournalBtn').addEventListener('click', () => this.showJournalSection());
                document.getElementById('copyCombinedTextBtn').addEventListener('click', () => this.copyJournalText());
                document.getElementById('exportToNotionBtn').addEventListener('click', () => this.exportToNotion());
                document.getElementById('backToMainJournalBtn').addEventListener('click', () => this.showJournalSection());
                document.getElementById('modalClose').addEventListener('click', () => UIUtil.hideModal());
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
            }

            checkInitialState() {
                const agreedToPrivacy = StorageUtil.load('agreedToPrivacy');
                const agreedToTerms = StorageUtil.load('agreedToTerms');
                const hasApiKey = StorageUtil.load('geminiApiKey');

                if (!agreedToPrivacy) {
                    UIUtil.showSection('privacySection');
                } else if (!agreedToTerms) {
                    UIUtil.showSection('termsSection');
                } else if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            showJournalSection() {
                UIUtil.showSection('journalSection');
                this.setTodayDate();
                document.getElementById('journalMood').value = "";
                this.displayRandomPhilosophy();
            }

            setTodayDate() {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('journalDate').value = dateString;
            }

            saveApiKey() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (!apiKey) {
                    UIUtil.showModal('API Key ထည့်သွင်းပါ။', 'error');
                    return;
                }
                StorageUtil.save('geminiApiKey', apiKey);
                UIUtil.showModal('API Key သိမ်းဆည်းပြီးပါပြီ။', 'success');
                this.showJournalSection();
            }

            clearApiKey() {
                StorageUtil.remove('geminiApiKey');
                document.getElementById('apiKeyInput').value = '';
                UIUtil.showModal('API Key ဖျက်လိုက်ပါပြီ။', 'success');
                UIUtil.showSection('apiKeySection');
            }

            submitFeedback() {
                const feedbackText = document.getElementById('feedbackTextarea').value.trim();
                if (!feedbackText) {
                    UIUtil.showModal('အကြံပြုချက် ထည့်သွင်းပါ။', 'error');
                    return;
                }
                const feedbackEntry = {
                    text: feedbackText,
                    timestamp: new Date().toISOString()
                };
                const feedbacks = StorageUtil.load('feedbacks') || [];
                feedbacks.push(feedbackEntry);
                StorageUtil.save('feedbacks', feedbacks);
                document.getElementById('feedbackTextarea').value = '';
                UIUtil.showModal('အကြံပြုချက် ပေးပို့ပြီးပါပြီ။', 'success');
            }

            promptForApiKeyOrStartJournaling() {
                const hasApiKey = StorageUtil.load('geminiApiKey');
                if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            async startPrompts() {
                if (this.isLoading) return;
                const startPromptsBtn = document.getElementById('startPromptsBtn');
                const originalText = startPromptsBtn.innerHTML;

                UIUtil.setLoading(startPromptsBtn, true, 'ဖန်တီးနေပါသည်...');
                this.isLoading = true;

                try {
                    const selectedMood = document.getElementById('journalMood').value;
                    if (!selectedMood) {
                        UIUtil.showModal('စိတ်ခံစားမှုကို ရွေးချယ်ပေးပါ။', 'error');
                        return;
                    }
                    const apiKey = StorageUtil.load('geminiApiKey');
                    if (!apiKey) {
                        UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
                        UIUtil.showSection('apiKeySection');
                        return;
                    }

                    this.activePrompts = await GeminiAPI.fetchPrompts(selectedMood, apiKey);
                    this.currentPromptIndex = 0;
                    this.promptAnswers = Array(this.activePrompts.length).fill('');
                    this.displayCurrentPrompt();
                    UIUtil.showSection('promptsSection');
                } catch (error) {
                    console.error('Error starting prompts:', error);
                    UIUtil.showModal(`မေးခွန်းများ ရယူရာတွင် ပြဿနာရှိခဲ့ပါသည်။: ${error.message}`, 'error');
                    this.activePrompts = [...this.defaultPrompts];
                    this.currentPromptIndex = 0;
                    this.promptAnswers = Array(this.activePrompts.length).fill('');
                    this.displayCurrentPrompt();
                    UIUtil.showSection('promptsSection');
                } finally {
                    this.isLoading = false;
                    UIUtil.setLoading(startPromptsBtn, false, originalText);
                }
            }

            displayCurrentPrompt() {
                const promptTextElem = document.getElementById('currentPromptText');
                const answerTextarea = document.getElementById('promptAnswerTextarea');
                const counterElem = document.getElementById('promptCounter');
                const prevBtn = document.getElementById('prevPromptBtn');
                const nextBtn = document.getElementById('nextPromptBtn');
                const combineBtn = document.getElementById('combineAnswersBtn');
                const promptDisplay = document.getElementById('promptDisplay');

                promptDisplay.classList.add('prompt-transition');
                setTimeout(() => {
                    promptTextElem.textContent = `${this.currentPromptIndex + 1}. ${this.activePrompts[this.currentPromptIndex]}`;
                    answerTextarea.value = this.promptAnswers[this.currentPromptIndex];
                    answerTextarea.focus();
                    counterElem.textContent = `${this.currentPromptIndex + 1}/${this.activePrompts.length}`;
                    prevBtn.disabled = (this.currentPromptIndex === 0);

                    if (this.currentPromptIndex === this.activePrompts.length - 1) {
                        nextBtn.classList.add('hidden');
                        combineBtn.classList.remove('hidden');
                    } else {
                        nextBtn.classList.remove('hidden');
                        combineBtn.classList.add('hidden');
                    }
                    UIUtil.updateProgressBar(this.currentPromptIndex + 1, this.activePrompts.length);
                    promptDisplay.classList.remove('prompt-transition');
                }, 200);
            }

            previousPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                this.currentPromptIndex--;
                this.displayCurrentPrompt();
            }

            nextPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                this.currentPromptIndex++;
                this.displayCurrentPrompt();
            }

            async combineAnswers() {
                if (this.isLoading) return;
                this.isLoading = true;
                UIUtil.showModal('အဖြေများ စုစည်းပြီး အကြံပြုချက် ရယူနေပါသည်။ ခဏစောင့်ပါ။', 'success');

                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();

                const combinedText = this.promptAnswers
                    .map((answer, index) => {
                        if (answer) {
                            return `${index + 1}. ${this.activePrompts[index]}\nအဖြေ: ${answer}`;
                        }
                        return '';
                    })
                    .filter(item => item !== '')
                    .join('\n\n---\n\n');

                document.getElementById('combinedJournalText').value = combinedText;

                const date = document.getElementById('journalDate').value;
                const mood = document.getElementById('journalMood').value;

                try {
                    const apiKey = StorageUtil.load('geminiApiKey');
                    if (!apiKey) {
                        UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
                        UIUtil.showSection('apiKeySection');
                        return;
                    }
                    const suggestionResult = await SuggestionModule.generateAffirmation(combinedText, mood, apiKey);

                    const newEntry = {
                        date,
                        mood,
                        text: combinedText,
                        affirmation: suggestionResult.affirmation
                    };

                    const entries = StorageUtil.load('journalEntries') || [];
                    entries.push(newEntry);
                    StorageUtil.save('journalEntries', entries);

                    document.getElementById('affirmationText').textContent = suggestionResult.affirmation || 'AI အကြံပြုချက်မရခဲ့ပါ။ သင့်ကိုယ်သင် အားပေးပါ။';
                    UIUtil.showSection('suggestionsSection');
                } catch (error) {
                    console.error('Error combining answers:', error);
                    document.getElementById('affirmationText').textContent = FALLBACK_AFFIRMATIONS[mood]?.[Math.floor(Math.random() * FALLBACK_AFFIRMATIONS[mood].length)] || 'သင့်ကိုယ်သင် ယုံကြည်မှုထားပါ၊ သင်သည် အရာအားလုံးကို ကျော်လွှားနိုင်ပါသည်။';
                    document.getElementById('combinedJournalText').value = combinedText;
                    UIUtil.showSection('suggestionsSection');
                    UIUtil.showModal(`အဖြေများ စုစည်းရာတွင် ပြဿနာရှိခဲ့ပါသည်။: ${error.message}`, 'error');
                } finally {
                    this.isLoading = false;
                }
            }

            copyJournalText() {
                const combinedText = document.getElementById('combinedJournalText').value;
                navigator.clipboard.writeText(combinedText).then(() => {
                    UIUtil.showModal('ဂျာနယ်မှတ်တမ်း ကူးယူပြီးပါပြီ။', 'success');
                }).catch(err => {
                    UIUtil.showModal('ကူးယူရာတွင် ပြဿနာရှိခဲ့ပါသည်။', 'error');
                    console.error('Copy failed:', err);
                });
            }

            exportToNotion() {
                const combinedText = document.getElementById('combinedJournalText').value;
                const markdownContent = `# ဂျာနယ်မှတ်တမ်း - ${new Date().toLocaleDateString('my-MM')}\n\n${combinedText}`;
                const blob = new Blob([markdownContent], { type: 'text/markdown' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `journal_${new Date().toISOString().split('T')[0]}.md`;
                a.click();
                window.URL.revokeObjectURL(url);
                UIUtil.showModal('Notion Markdown ဖိုင် ထုတ်ယူပြီးပါပြီ။', 'success');
            }

            displayRandomPhilosophy() {
                const { text, credit } = this.philosophyTexts[Math.floor(Math.random() * this.philosophyTexts.length)];
                document.getElementById('philosophyText').textContent = text;
                document.getElementById('sourceCredit').textContent = credit;
            }

            handleKeydown(e) {
                if (document.getElementById('promptsSection').classList.contains('active')) {
                    if (e.key === 'ArrowLeft' && !document.getElementById('prevPromptBtn').disabled) {
                        this.previousPrompt();
                    } else if (e.key === 'ArrowRight') {
                        this.nextPrompt();
                    }
                }
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => new JournalApp());
    </script>
</body>
</html>
