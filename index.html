<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>နေ့စဉ်မှတ်တမ်း</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyidaungsu Font via Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font and global styles */
        :root {
            --primary-color: #1e40af;
            --primary-hover: #1d4ed8;
            --secondary-color: #6b7280;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --modal-background: rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Pyidaungsu', "Inter", sans-serif;
            background-color: var(--background-color);
            line-height: 1.6;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-size: clamp(0.875rem, 2.5vw, 1rem); /* Responsive font size */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            width: 100%;
            max-width: 768px;
            padding: 1rem;
            margin: 0 auto;
        }

        @media (min-width: 640px) {
            .container {
                padding: 1.5rem;
            }
        }

        .card {
            background-color: var(--card-background);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            animation: cardFadeIn 0.5s ease-out forwards;
        }

        @keyframes cardFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            text-decoration: none;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            min-width: 48px; /* Ensure minimum touch target size */
            min-height: 48px; /* Ensure minimum touch target size */
            position: relative;
            overflow: hidden;
            touch-action: manipulation; /* Improves responsiveness on touch devices */
            transition: all 0.2s ease-in-out; /* Smooth transitions for all button states */
        }

        .btn:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Hover and active effects for buttons */
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #4b5563;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning { /* Added for the insight button */
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #d97706; /* Darker orange on hover */
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            background-color: var(--card-background);
            position: relative;
            transition: all 0.2s ease-in-out;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgb(59 130 246 / 0.3);
            transform: scale(1.01);
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 0.5rem;
            height: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.5s ease-in-out;
            border-radius: 0.5rem;
        }

        @media (max-width: 640px) {
            .progress-container {
                height: 0.75rem;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 400px;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        @media (max-width: 640px) {
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0 1rem;
                padding: 1rem;
            }
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal.success .modal-content {
            border-left: 4px solid var(--success-color);
        }

        .modal.error .modal-content {
            border-left: 4px solid var(--error-color);
        }

        /* Prompt Display */
        .prompt-display {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border: 2px solid #0ea5e9;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .prompt-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .prompt-display.prompt-transition::before {
            left: 100%;
        }

        /* Analysis Section */
        .analysis-section {
            background: linear-gradient(135deg, #f0fff4 0%, #f7fee7 100%);
            border: 2px solid #22c55e;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: scale(0.95);
            animation: analysisFadeIn 0.5s ease-out forwards;
        }

        @keyframes analysisFadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .analysis-section:nth-child(1) { animation-delay: 0.1s; }
        .analysis-section:nth-child(2) { animation-delay: 0.2s; }
        .analysis-section:nth-child(3) { animation-delay: 0.3s; }
        .analysis-section:nth-child(4) { animation-delay: 0.4s; }

        .hidden {
            display: none !important;
        }

        /* Mood Selector styles (Reverted to dropdown, so these are not actively used for mood buttons) */
        .mood-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 columns on small screens (mobile-first) */
            gap: 0.75rem; /* Increased gap for better spacing */
            margin-top: 1rem;
        }

        @media (min-width: 640px) { /* Medium screens (sm) - e.g., larger phones, small tablets */
            .mood-selector {
                grid-template-columns: repeat(3, 1fr); /* 3 columns on medium screens */
            }
        }

        @media (min-width: 768px) { /* Large screens (md) - e.g., tablets, desktops */
            .mood-selector {
                grid-template-columns: repeat(4, 1fr); /* 4 columns on large screens */
            }
        }

        .mood-btn {
            padding: 1rem 0.75rem; /* Adjusted padding for better button size */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Increased space between emoji and text */
            background-color: #f8fafc; /* Lighter background for default */
            color: var(--text-primary);
            border: 1px solid var(--border-color); /* Subtle border */
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm); /* Lighter default shadow */
        }

        .mood-btn:hover:not(.selected) {
            background-color: #e2e8f0; /* Light gray on hover for unselected */
            transform: translateY(-2px);
            box-shadow: var(--shadow-md); /* More pronounced shadow on hover */
        }

        .mood-btn.selected {
            background-color: var(--primary-color); /* Primary color for selected mood */
            color: white;
            border-color: var(--primary-hover);
            box-shadow: var(--shadow-lg); /* Stronger shadow for selected */
            transform: translateY(-2px);
        }

        .mood-btn span.emoji {
            font-size: 2rem; /* Larger emoji for better visibility */
            line-height: 1;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Mobile-Specific Adjustments */
        @media (max-width: 640px) {
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                padding: 0.75rem;
            }

            .flex-wrap {
                flex-direction: column;
                align-items: stretch;
            }

            .text-4xl {
                font-size: clamp(1.5rem, 5vw, 2rem);
            }

            .text-2xl {
                font-size: clamp(1.25rem, 4vw, 1.5rem);
            }

            .text-xl {
                font-size: clamp(1rem, 3.5vw, 1.25rem);
            }

            .textarea-field {
                min-height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="text-4xl font-bold text-center text-blue-800 mb-8">နေ့စဉ်မှတ်တမ်း</h1>
            
            <!-- Main Content Area -->
            <div id="app-content" role="main">
                <!-- Privacy Policy Section -->
                <div id="privacySection" class="section hidden" aria-labelledby="privacy-title">
                    <h2 id="privacy-title" class="text-2xl font-bold text-center text-orange-700 mb-6">ကိုယ်ရေးအချက်အလက်ကာကွယ်မှု</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App သည် သုံးစွဲသူများ၏ ကိုယ်ရေးအချက်အလက် လုံခြုံရေးကို အလေးထားပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ အချက်အလက်သိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>သင့်၏ ဂျာနယ်မှတ်တမ်းများကို သင့် Browser ၏ Local Storage တွင်သာ သိမ်းဆည်းထားပါသည်။</li>
                                <li>မည်သည့် Server သို့မှ အချက်အလက်မျှ ပေးပို့ခြင်းမရှိပါ။</li>
                                <li>၎င်းသည် သင့်အချက်အလက်များကို သင့်ထိန်းချုပ်မှုအောက်တွင်သာ ရှိစေပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်ဖောက်ပြားမှု ကာကွယ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>အချက်အလက်များ Local Storage တွင်သာ ရှိသောကြောင့် ပြင်ပ Server များမှ ပေါက်ကြားနိုင်ခြေ မရှိပါ။</li>
                                <li>Browser Cache ရှင်းလင်းပါက မှတ်တမ်းများ ပျောက်ဆုံးနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ပြင်ပဝန်ဆောင်မှုများ</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Google Gemini API ကို သုံးသပ်ချက်ရယူရန်အတွက်သာ အသုံးပြုပါသည်။</li>
                                <li>သင့်ကိုယ်ရေးအချက်အလက်များကို သိမ်းဆည်းခြင်း မရှိပါ။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreePrivacyBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- Terms Section -->
                <div id="termsSection" class="section hidden" aria-labelledby="terms-title">
                    <h2 id="terms-title" class="text-2xl font-bold text-center text-yellow-700 mb-6">စည်းမျဉ်းနှင့် သတ်မှတ်ချက်များ</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App ကို အသုံးပြုခြင်းဖြင့် အောက်ပါ စည်းမျဉ်းများကို သဘောတူညီရာ ရောက်ပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ App အသုံးပြုခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ကိုယ်ပိုင် ဂျာနယ်မှတ်တမ်းရေးသားခြင်းအတွက်သာ အသုံးပြုရပါမည်။</li>
                                <li>မလျော်ကန်သော နည်းလမ်းများဖြင့် အသုံးပြုခြင်းကို တားမြစ်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်များ</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>မှတ်တမ်းများ ပျောက်ဆုံးခြင်းအတွက် App ဖန်တီးသူတွင် တာဝန်မရှိပါ။</li>
                                <li>အရေးကြီးသော မှတ်တမ်းများကို Backup လုပ်ထားရန် အကြံပြုပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ဝန်ဆောင်မှု</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ဤ App ကို "ရှိပြီးသားအတိုင်း" ပေးထားခြင်းဖြစ်ပြီး မည်သည့် အာမခံချက်မျှ မရှိပါ။</li>
                                <li>လုပ်ဆောင်ချက်များ အချိန်မရွေး ပြောင်းလဲနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreeTermsBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- User Guide Section -->
                <div id="guideSection" class="section hidden" aria-labelledby="guide-title">
                    <h2 id="guide-title" class="text-2xl font-bold text-center text-blue-700 mb-6">အသုံးပြုနည်းလမ်းညွှန်</h2>
                    <div class="space-y-6 text-gray-700">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ ဂျာနယ်စတင်ရေးသားခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>လက်ရှိရက်စွဲကို အလိုအလျောက် သတ်မှတ်ပေးထားပါသည်။</li>
                                <li>စိတ်ခံစားမှုကို ရွေးချယ်ပြီး "မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်" ကို နှိပ်ပါ။</li>
                                <li>မေးခွန်းတစ်ခုချင်းစီကို ဖြေကြားပြီး "နောက်မေးခွန်း" သို့ ရွှေ့ပါ။</li>
                                <li>ဖုန်းတွင် နှိပ်ရုံဖြင့်လည်း နောက်မေးခွန်းသို့ ရွှေ့နိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ မှတ်တမ်းသိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"အဖြေများ စုစည်းမည်" ကို နှိပ်လျှင် အလိုအလျောက် သိမ်းဆည်းပါသည်။</li>
                                <li>AI သုံးသပ်ချက်အချို့အရ အဓိကအကြောင်းအရာများနှင့် လုပ်ဆောင်ရမည့်အချက်များကို ထုတ်ပေးပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ Export လုပ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"Notion Markdown ထုတ်မည်" ကို နှိပ်ပြီး Markdown ဖိုင်ကို ရယူနိုင်ပါသည်။</li>
                                <li>ထိုဖိုင်ကို Notion သို့ Drag & Drop ဖြင့် တင်သွင်းနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="startJournalingBtn" class="btn btn-primary" aria-label="ဂျာနယ်စတင်ရေးမည်">ဂျာနယ်စတင်ရေးမည်</button>
                    </div>
                </div>

                <!-- API Key Input Section -->
                <div id="apiKeySection" class="section hidden" aria-labelledby="api-key-title">
                    <h2 id="api-key-title" class="text-2xl font-bold text-center text-blue-700 mb-6">Gemini API Key</h2>
                    <div class="space-y-4">
                        <p class="text-gray-600">သင်၏ဂျာနယ်မှတ်တမ်းများကို AI ဖြင့် သုံးသပ်ရန်အတွက် Google Gemini API Key လိုအပ်ပါသည်။</p>
                        <p class="text-sm text-gray-500">API Key ကို <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a> မှ ရယူနိုင်ပါသည်။</p>
                        <input type="password" id="apiKeyInput" class="input-field" placeholder="Enter your Gemini API Key" aria-label="Gemini API Key" required>
                        <div class="text-center">
                            <button id="saveApiKeyBtn" class="btn btn-primary" aria-label="သိမ်းမည်">သိမ်းမည်</button>
                        </div>
                    </div>
                </div>

                <!-- Main Journal Section -->
                <div id="journalSection" class="section hidden">
                    <!-- Date and Mood Selection -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="journalDate" class="block text-gray-700 font-medium mb-2">ရက်စွဲ:</label>
                            <input type="date" id="journalDate" class="input-field" aria-label="ရက်စွဲ ရွေးပါ" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">စိတ်ခံစားမှု:</label>
                            <select id="journalMood" class="input-field" aria-label="စိတ်ခံစားမှု ရွေးပါ" required>
                                <option value="">စိတ်ခံစားမှု ရွေးပါ</option>
                                <option value="ပျော်ရွှင်">ပျော်ရွှင် 😊</option>
                                <option value="ဝမ်းနည်း">ဝမ်းနည်း 😢</option>
                                <option value="စိတ်တို">စိတ်တို 😠</option>
                                <option value="စိတ်လှုပ်ရှား">စိတ်လှုပ်ရှား 🤩</option>
                                <option value="ငြိမ်သက်">ငြိမ်သက် 😌</option>
                                <option value="ပင်ပန်း">ပင်ပန်း 😴</option>
                                <option value="စိတ်ရှုပ်">စိတ်ရှုပ် 😕</option>
                                <option value="ကျေနပ်">ကျေနပ် 👍</option>
                            </select>
                        </div>
                    </div>

                    <!-- Life Reflection Philosophy -->
                    <div class="mt-6 bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h3 class="text-lg font-semibold text-blue-900">ဘဝဆိုင်ရာ တွေးတောမှု</h3>
                        <p id="philosophyText" class="text-blue-700"></p>
                        <p id="sourceCredit" class="text-xs text-blue-600 mt-2"></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="startPromptsBtn" class="btn btn-primary">
                            <span id="startPromptsBtnText">✨ မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်</span>
                        </button>
                        <button id="clearApiKeyBtn" class="btn btn-danger">API Key ဖယ်ရှားမည်</button>
                    </div>
                </div>

                <!-- Prompts Section -->
                <div id="promptsSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">ဂျာနယ်မေးခွန်းများ</h2>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="promptDisplay" class="prompt-display">
                        <p id="currentPromptText" class="text-lg font-medium text-blue-900 mb-4"></p>
                        <textarea id="promptAnswerTextarea" class="input-field textarea-field" placeholder="သင့်အဖြေကို ဤနေရာတွင် ရေးပါ" aria-label="မေးခွန်းအတွက် အဖြေ"></textarea>
                    </div>
                    <div class="flex justify-between gap-4">
                        <button id="prevPromptBtn" class="btn btn-secondary" disabled aria-label="ယခင်မေးခွန်း">ယခင်မေးခွန်း</button>
                        <span id="promptCounter" class="text-gray-600 self-center" aria-live="polite">1/5</span>
                        <button id="nextPromptBtn" class="btn btn-primary" aria-label="နောက်မေးခွန်း">နောက်မေးခွန်း</button>
                        <button id="combineAnswersBtn" class="btn btn-success hidden" aria-label="အဖြေများ စုစည်းမည်">အဖြေများ စုစည်းမည်</button>
                    </div>
                    <div class="text-center mt-6">
                        <button id="backToJournalBtn" class="btn btn-secondary" aria-label="ပင်မစာမျက်နှာသို့ ပြန်သွားမည်">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>

                <!-- Analysis Results Section -->
                <div id="analysisSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">သုံးသပ်ချက်နှင့် ရလဒ်များ</h2>
                    <!-- Summary -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အနှစ်ချုပ်</h3>
                        <p id="analysisSummary" class="text-gray-700"></p>
                    </div>
                    <!-- Key Themes -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အဓိကအကြောင်းအရာများ</h3>
                        <ul id="keyThemesList" class="list-disc list-inside text-gray-700"></ul>
                    </div>
                    <!-- Action Items -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">လုပ်ဆောင်ရမည့်အချက်များ</h3>
                        <ul id="actionItemsList" class="list-disc list-inside text-gray-700"></ul>
                    </div>
                    <!-- Affirmation -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အားပေးစကား</h3>
                        <p id="affirmationDisplay" class="text-gray-700"></p>
                    </div>

                    <!-- Removed Future Self Letter Section and its button -->

                    <!-- Journal Text -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ဂျာနယ်မှတ်တမ်း</h3>
                        <textarea id="combinedJournalText" class="input-field textarea-field" style="min-height: 300px;" readonly aria-label="ဂျာနယ်မှတ်တမ်း"></textarea>
                        <div class="flex justify-center gap-4 mt-4">
                            <button id="copyCombinedTextBtn" class="btn btn-success" aria-label="အားလုံးကူးယူမည်">အားလုံးကူးယူမည်</button>
                            <button id="exportToNotionBtn" class="btn btn-primary" aria-label="Notion Markdown ထုတ်မည်">Notion Markdown ထုတ်မည်</button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button id="backToMainJournalBtn" class="btn btn-secondary" aria-label="ပင်မစာမျက်နှာသို့ ပြန်သွားမည်">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
            <div class="modal-content">
                <button id="modalClose" class="modal-close" aria-label="ပိတ်မည်">×</button>
                <p id="modalMessage" class="text-center font-semibold"></p>
            </div>
        </div>
    </div>

    <script>
        // Utility module for localStorage operations
        const StorageUtil = {
            save(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Error saving ${key}: ${e.message}`);
                    return false;
                }
            },
            load(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error(`Error loading ${key}: ${e.message}`);
                    return null;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error(`Error removing ${key}: ${e.message}`);
                    return false;
                }
            }
        };

        // API module for Gemini API interactions
        const GeminiAPI = {
            async fetchPrompts(mood, apiKey) {
                const prompt = mood
                    ? `Generate 5 distinct journaling prompts in Burmese, suitable for someone experiencing a '${mood}' mood. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`
                    : `Generate 5 journaling prompts in Burmese. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`;

                return this._makeApiCall(prompt, { type: 'ARRAY', items: { type: 'STRING' } }, apiKey, "gemini-2.0-flash");
            },

            async fetchAnalysis(journalText, mood, apiKey) {
                const prompt = `Analyze the following journal entry in Burmese:\n\n${journalText}\n\nMood: ${mood}\n\nAll responses must be in Burmese language only. Provide a JSON response with the following structure:\n{\n  "summary": "A brief summary of the journal entry in Burmese.",\n  "themes": ["theme1 in Burmese", "theme2 in Burmese", "theme3 in Burmese"],\n  "actions": ["action1 in Burmese", "action2 in Burmese"],\n  "affirmation": "A positive affirmation based on the entry in Burmese."\n}`;

                return this._makeApiCall(prompt, {
                    type: 'OBJECT',
                    properties: {
                        summary: { type: 'STRING' },
                        themes: { type: 'ARRAY', items: { type: 'STRING' } },
                        actions: { type: 'ARRAY', items: { type: 'STRING' } },
                        affirmation: { type: 'STRING' }
                    },
                    required: ['summary', 'themes', 'actions', 'affirmation']
                }, apiKey, "gemini-2.0-flash");
            },

            // Removed fetchFutureSelfLetter as per user request to revert UI
            // async fetchFutureSelfLetter(journalText, apiKey) {
            //     const prompt = `အောက်ပါ ဂျာနယ်မှတ်တမ်းကို အခြေခံ၍ အနာဂတ်တွင်ရှိမည့် သင့်ကိုယ်သင် ပေးပို့မည့် စာတစ်စောင်ကို မြန်မာဘာသာဖြင့် ရေးသားပေးပါ။ ဤစာသည် လက်ရှိအခြေအနေကို ပြန်လည်သုံးသပ်ခြင်း၊ သင်ယူခဲ့ရသော သင်ခန်းစာများကို သတိပေးခြင်း၊ အားပေးစကားများ ပေးခြင်းနှင့် မျှော်မှန်းချက်များ ဖော်ပြခြင်းတို့ ပါဝင်သင့်သည်။ စာကို တိုတိုနှင့် ထိရောက်မှုရှိအောင် ရေးသားပါ။\n\nဂျာနယ်မှတ်တမ်း:\n${journalText}`;
            //     return this._makeApiCall(prompt, null, apiKey, "gemini-2.0-flash", "text/plain"); // No specific schema, expect plain text
            // },

            async _makeApiCall(prompt, schema, apiKey, model = "gemini-2.0-flash", responseMimeType = "application/json") {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
                const payload = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: schema ? { responseMimeType: responseMimeType, responseSchema: schema } : { responseMimeType: responseMimeType },
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                        ]
                    })
                };

                try {
                    const response = await fetch(apiUrl, payload);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMsg = errorData?.error?.message || response.statusText;
                        if (response.status === 403) {
                            throw new Error(`API Key မှားယွင်းနေပါသည်။ ကျေးဇူးပြု၍ Google AI Studio (https://aistudio.google.com/app/apikey) မှ မှန်ကန်သော API Key ကို ထည့်သွင်းပေးပါ။`);
                        } else if (response.status === 429) {
                            throw new Error(`သင့် API အသုံးပြုမှု ကန့်သတ်ချက် ပြည့်နေပါပြီ။ ကျေးဇူးပြု၍ Google AI Studio (https://aistudio.google.com/app/apikey) တွင် သင့် Plan နှင့် Billing အချက်အလက်များကို စစ်ဆေးပါ။`);
                        } else if (response.status === 503) {
                            throw new Error(`AI Model အလုပ်များနေပါသည်။ ခဏစောင့်ပြီး ပြန်လည်ကြိုးစားကြည့်ပါ။`);
                        } else {
                            throw new Error(`API ချိတ်ဆက်မှု ပြဿနာရှိခဲ့ပါသည်။ Status: ${response.status} ${errorMsg}`);
                        }
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        if (responseMimeType === "application/json") {
                            return JSON.parse(result.candidates[0].content.parts[0].text);
                        } else {
                            return result.candidates[0].content.parts[0].text;
                        }
                    }
                    throw new Error('Unexpected API response structure.');
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        };

        // UI utility module
        const UIUtil = {
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    setTimeout(() => targetSection.classList.add('active'), 50);
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                    targetSection.focus(); // For accessibility
                }
            },

            showModal(message, type = 'success') {
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modalMessage');
                modalMessage.textContent = message;
                modal.className = `modal show ${type}`; // Reset classes and add new ones
                modal.focus(); // For accessibility
                setTimeout(() => this.hideModal(), 3000);
            },

            hideModal() {
                const modal = document.getElementById('modal');
                modal.classList.remove('show', 'success', 'error'); // Remove all type classes
            },

            setLoading(element, isLoading, originalText = '', spinnerHtml = '<span class="loading-spinner"></span>') {
                if (isLoading) {
                    element.disabled = true;
                    element.innerHTML = spinnerHtml + originalText;
                } else {
                    element.disabled = false;
                    element.innerHTML = originalText;
                }
            },

            updateProgressBar(current, total) {
                const progressBar = document.getElementById('progressBar');
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            }
        };

        // Main Journal App Class
        class JournalApp {
            constructor() {
                this.currentPromptIndex = 0;
                this.promptAnswers = [];
                this.activePrompts = [];
                this.defaultPrompts = [
                    "ဒီနေ့အတွက် ကျေးဇူးတင်စရာ ဘာတွေရှိလဲ။",
                    "ဒီနေ့ ဘယ်အရာက သင့်ကို ပျော်ရွှင်စေခဲ့လဲ။",
                    "ဒီနေ့ သင်ယူခဲ့ရတဲ့ အရာတစ်ခုခု ရှိလား။",
                    "ဒီနေ့ ဘယ်လို စိတ်ခံစားမှုမျိုး ခံစားခဲ့ရလဲ။ ဘာကြောင့်လဲ။",
                    "ကိုယ့်ကိုယ်ကို ပိုကောင်းအောင် ဘာတွေ လုပ်နိုင်ခဲ့လဲ။",
                    "ဒီနေ့ ဘယ်သူ့ကို ကူညီပေးခဲ့လဲ၊ ဒါမှမဟုတ် ဘယ်သူက သင့်ကို ကူညီခဲ့လဲ။",
                    "မနက်ဖြန်အတွက် ဘာတွေ မျှော်လင့်ထားလဲ။",
                    "ဒီနေ့ ကြုံတွေ့ခဲ့ရတဲ့ စိန်ခေါ်မှုတစ်ခုခုရှိလား။ ဘယ်လို ကျော်လွှားခဲ့လဲ။",
                    "သင့်ရဲ့ ရည်မှန်းချက်တွေဆီကို တစ်လှမ်းနီးအောင် ဒီနေ့ ဘာတွေ လုပ်ဆောင်နိုင်ခဲ့လဲ။",
                    "ဒီနေ့အတွက် သင်ကိုယ်တိုင် ဘာမက်ဆေ့ချ် ပေးချင်လဲ။"
                ];
                this.isLoading = false;
                // this.selectedMood = ''; // Removed as per user request to revert to dropdown
                this.philosophyTexts = [
                    {
                        text: "တစ်နေ့တာ ၁၀ မိနစ်လောက် ကိုယ့်ကိုယ်ကို ပြန်သုံးသပ်တဲ့အချိန်ပေးတာက ဘဝတိုးတက်ဖို့အတွက် အရေးကြီးဆုံးအရာတွေထဲက တစ်ခုပါပဲ။ တစ်ရက်တာလုံးမှာ ဘာတွေလုပ်ခဲ့လဲ၊ ကောင်းတဲ့အရာတွေနှင့် သင်ခန်းစာယူစရာများကို ပြန်ကြည့်ပြီး နောင်အတွက်ပြင်ဆင်တာက တိုးတက်ဖို့ အကောင်းဆုံးနည်းလမ်းပါ။",
                        credit: "Credit: KO LAPYAE"
                    },
                    {
                        text: "နေ့စဉ် ဂျာနယ်ရေးသားခြင်းသည် မိမိကိုယ်ကို ပိုမိုနားလည်စေပြီး စိတ်ဖိစီးမှုများကို လျှော့ချကာ စိတ်ပိုင်းဆိုင်ရာ ကျန်းမာရေးကို မြှင့်တင်ပေးသည်။ ၎င်းသည် အတွေးများကို စနစ်တကျ မှတ်တမ်းတင်နိုင်ပြီး ပြဿနာများကို ဖြေရှင်းရန် အထောက်အကူပြုသည်။",
                        credit: "Source: Journaling for Mental Health"
                    },
                    {
                        text: "သင်၏အတွေးများနှင့် ခံစားချက်များကို ချရေးခြင်းဖြင့် ရှင်းလင်းပြတ်သားသော အမြင်များကို ရရှိစေပြီး ပန်းတိုင်များ ချမှတ်ရာတွင် ပိုမိုလွယ်ကူစေသည်။ ၎င်းသည် မိမိကိုယ်ကို တိုးတက်အောင် လုပ်ဆောင်နိုင်သည့် အစွမ်းထက်သော ကိရိယာတစ်ခုဖြစ်သည်။",
                        credit: "Source: The Power of Journaling"
                    }
                ];
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkInitialState();
                this.displayRandomPhilosophy();
            }

            bindEvents() {
                // Initial flow buttons
                document.getElementById('agreePrivacyBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToPrivacy', 'true');
                    UIUtil.showSection('termsSection');
                });
                document.getElementById('agreeTermsBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToTerms', 'true');
                    UIUtil.showSection('guideSection');
                });
                document.getElementById('startJournalingBtn').addEventListener('click', () => this.promptForApiKeyOrStartJournaling());

                // API Key management
                document.getElementById('saveApiKeyBtn').addEventListener('click', () => this.saveApiKey());
                document.getElementById('clearApiKeyBtn').addEventListener('click', () => this.clearApiKey());

                // Journal section buttons
                document.getElementById('startPromptsBtn').addEventListener('click', () => this.startPrompts());
                // Removed mood button event listeners as per user request to revert to dropdown
                // document.querySelectorAll('.mood-btn').forEach(button => {
                //     button.addEventListener('click', (event) => this.selectMood(event.currentTarget.dataset.mood));
                // });

                // Prompts section buttons
                document.getElementById('prevPromptBtn').addEventListener('click', () => this.previousPrompt());
                document.getElementById('nextPromptBtn').addEventListener('click', () => this.nextPrompt());
                document.getElementById('combineAnswersBtn').addEventListener('click', () => this.combineAnswers());
                document.getElementById('backToJournalBtn').addEventListener('click', () => this.showJournalSection());

                // Analysis section buttons
                document.getElementById('copyCombinedTextBtn').addEventListener('click', () => this.copyJournalText());
                document.getElementById('exportToNotionBtn').addEventListener('click', () => this.exportToNotion());
                // Removed generateFutureLetterBtn and copyFutureLetterBtn event listeners
                // document.getElementById('generateFutureLetterBtn').addEventListener('click', () => this.generateFutureSelfLetter());
                // document.getElementById('copyFutureLetterBtn').addEventListener('click', () => this.copyFutureLetter());
                document.getElementById('backToMainJournalBtn').addEventListener('click', () => this.showJournalSection());

                // Modal close button
                document.getElementById('modalClose').addEventListener('click', () => UIUtil.hideModal());

                // Global keyboard events
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
            }

            checkInitialState() {
                const agreedToPrivacy = StorageUtil.load('agreedToPrivacy');
                const agreedToTerms = StorageUtil.load('agreedToTerms');
                const hasApiKey = StorageUtil.load('geminiApiKey');

                if (!agreedToPrivacy) {
                    UIUtil.showSection('privacySection');
                } else if (!agreedToTerms) {
                    UIUtil.showSection('termsSection');
                } else if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            showJournalSection() {
                UIUtil.showSection('journalSection');
                this.setTodayDate();
                // this.selectedMood = ''; // Removed as per user request
                // this.updateMoodSelectionUI(); // Removed as per user request
                document.getElementById('journalMood').value = ""; // Reset dropdown
                this.displayRandomPhilosophy(); // Show a new philosophy text
            }

            setTodayDate() {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('journalDate').value = dateString;
            }

            // Removed selectMood and updateMoodSelectionUI as per user request to revert to dropdown
            // selectMood(mood) {
            //     this.selectedMood = mood;
            //     this.updateMoodSelectionUI();
            // }

            // updateMoodSelectionUI() {
            //     document.querySelectorAll('.mood-btn').forEach(button => {
            //         if (button.dataset.mood === this.selectedMood) {
            //             button.classList.add('selected');
            //         } else {
            //             button.classList.remove('selected');
            //         }
            //     });
            // }

            saveApiKey() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (!apiKey) {
                    UIUtil.showModal('API Key ထည့်သွင်းပါ။', 'error');
                    return;
                }
                StorageUtil.save('geminiApiKey', apiKey);
                UIUtil.showModal('API Key သိမ်းဆည်းပြီးပါပြီ။', 'success');
                this.showJournalSection();
            }

            clearApiKey() {
                StorageUtil.remove('geminiApiKey');
                document.getElementById('apiKeyInput').value = '';
                UIUtil.showModal('API Key ဖျက်လိုက်ပါပြီ။', 'success');
                UIUtil.showSection('apiKeySection');
            }

            promptForApiKeyOrStartJournaling() {
                const hasApiKey = StorageUtil.load('geminiApiKey');
                if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            async startPrompts() {
                if (this.isLoading) return;
                const startPromptsBtn = document.getElementById('startPromptsBtn');
                const originalText = startPromptsBtn.innerHTML;

                UIUtil.setLoading(startPromptsBtn, true, 'ဖန်တီးနေပါသည်...');
                this.isLoading = true;

                try {
                    const selectedMood = document.getElementById('journalMood').value; // Get mood from dropdown
                    if (!selectedMood) { // Check if mood is selected
                        UIUtil.showModal('စိတ်ခံစားမှုကို ရွေးချယ်ပေးပါ။', 'error');
                        return;
                    }
                    const apiKey = StorageUtil.load('geminiApiKey');
                    if (!apiKey) {
                        UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
                        UIUtil.showSection('apiKeySection');
                        return;
                    }

                    this.activePrompts = await GeminiAPI.fetchPrompts(selectedMood, apiKey); // Pass selectedMood
                    this.currentPromptIndex = 0;
                    this.promptAnswers = Array(this.activePrompts.length).fill('');
                    this.displayCurrentPrompt();
                    UIUtil.showSection('promptsSection');
                } catch (error) {
                    console.error('Error starting prompts:', error);
                    UIUtil.showModal(`မေးခွန်းများ ရယူရာတွင် ပြဿနာရှိခဲ့ပါသည်။: ${error.message}`, 'error');
                    // Fallback to default prompts if API fails
                    this.activePrompts = [...this.defaultPrompts];
                    this.currentPromptIndex = 0;
                    this.promptAnswers = Array(this.activePrompts.length).fill('');
                    this.displayCurrentPrompt();
                    UIUtil.showSection('promptsSection');
                } finally {
                    this.isLoading = false;
                    UIUtil.setLoading(startPromptsBtn, false, originalText);
                }
            }

            displayCurrentPrompt() {
                const promptTextElem = document.getElementById('currentPromptText');
                const answerTextarea = document.getElementById('promptAnswerTextarea');
                const counterElem = document.getElementById('promptCounter');
                const prevBtn = document.getElementById('prevPromptBtn');
                const nextBtn = document.getElementById('nextPromptBtn');
                const combineBtn = document.getElementById('combineAnswersBtn');
                const promptDisplay = document.getElementById('promptDisplay');

                // Add transition class for visual effect
                promptDisplay.classList.add('prompt-transition');
                setTimeout(() => {
                    promptTextElem.textContent = `${this.currentPromptIndex + 1}. ${this.activePrompts[this.currentPromptIndex]}`;
                    answerTextarea.value = this.promptAnswers[this.currentPromptIndex];
                    answerTextarea.focus();
                    counterElem.textContent = `${this.currentPromptIndex + 1}/${this.activePrompts.length}`;
                    prevBtn.disabled = (this.currentPromptIndex === 0);

                    if (this.currentPromptIndex === this.activePrompts.length - 1) {
                        nextBtn.classList.add('hidden');
                        combineBtn.classList.remove('hidden');
                    } else {
                        nextBtn.classList.remove('hidden');
                        combineBtn.classList.add('hidden');
                    }
                    UIUtil.updateProgressBar(this.currentPromptIndex + 1, this.activePrompts.length);
                    promptDisplay.classList.remove('prompt-transition'); // Remove after content update
                }, 200); // Small delay for transition effect
            }

            previousPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                this.currentPromptIndex--;
                this.displayCurrentPrompt();
            }

            nextPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                this.currentPromptIndex++;
                this.displayCurrentPrompt();
            }

            async combineAnswers() {
                if (this.isLoading) return;
                this.isLoading = true;
                UIUtil.showModal('အဖြေများ စုစည်းပြီး သုံးသပ်ချက် ရယူနေပါသည်။ ခဏစောင့်ပါ။', 'success');

                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();

                const combinedText = this.promptAnswers
                    .map((answer, index) => {
                        if (answer) {
                            return `${index + 1}. ${this.activePrompts[index]}\nအဖြေ: ${answer}`;
                        }
                        return '';
                    })
                    .filter(item => item !== '')
                    .join('\n\n---\n\n');

                document.getElementById('combinedJournalText').value = combinedText;

                const date = document.getElementById('journalDate').value;
                const mood = document.getElementById('journalMood').value; // Get mood from dropdown

                try {
                    const apiKey = StorageUtil.load('geminiApiKey');
                    if (!apiKey) {
                        UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
                        UIUtil.showSection('apiKeySection');
                        return;
                    }
                    const analysis = await GeminiAPI.fetchAnalysis(combinedText, mood, apiKey);

                    const newEntry = {
                        date,
                        mood,
                        text: combinedText,
                        summary: analysis.summary,
                        action_items: analysis.actions,
                        key_themes: analysis.themes,
                        affirmation: analysis.affirmation,
                        // future_letter: '' // Removed as per user request
                    };

                    const entries = StorageUtil.load('journalEntries') || [];
                    const existingEntryIndex = entries.findIndex(entry => entry.date === date);
                    if (existingEntryIndex > -1) {
                        entries[existingEntryIndex] = newEntry;
                        UIUtil.showModal("မှတ်တမ်း အပ်ဒိတ်လုပ်ပြီးပါပြီ။", "success");
                    } else {
                        entries.push(newEntry);
                        UIUtil.showModal("မှတ်တမ်း သိမ်းဆည်းပြီးပါပြီ။", "success");
                    }
                    StorageUtil.save('journalEntries', entries);

                    this.displayAnalysisResults(analysis);
                    UIUtil.showSection('analysisSection');

                } catch (error) {
                    console.error('Error combining answers and getting analysis:', error);
                    UIUtil.showModal(`သုံးသပ်ချက်ရယူရာတွင် ပြဿနာရှိခဲ့ပါသည်။: ${error.message}`, 'error');
                } finally {
                    this.isLoading = false;
                }
            }

            displayAnalysisResults(analysis) {
                document.getElementById('analysisSummary').textContent = analysis.summary || "သုံးသပ်ချက် မရရှိပါ။";

                const actionItemsList = document.getElementById('actionItemsList');
                actionItemsList.innerHTML = '';
                if (analysis.actions && analysis.actions.length > 0) {
                    analysis.actions.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        actionItemsList.appendChild(li);
                    });
                } else {
                    actionItemsList.innerHTML = '<li>လုပ်ဆောင်ရမည့်အချက်များ မရှိပါ။</li>';
                }

                const keyThemesList = document.getElementById('keyThemesList');
                keyThemesList.innerHTML = '';
                if (analysis.themes && analysis.themes.length > 0) {
                    analysis.themes.forEach(theme => {
                        const li = document.createElement('li');
                        li.textContent = theme;
                        keyThemesList.appendChild(li);
                    });
                } else {
                    keyThemesList.innerHTML = '<li>အဓိကအကြောင်းအရာများ မရှိပါ။</li>';
                }

                document.getElementById('affirmationDisplay').textContent = analysis.affirmation || "အားပေးစကား မရရှိပါ။";

                // Removed future letter section display logic
                // document.getElementById('futureLetterSection').classList.add('hidden');
                // document.getElementById('futureLetterDisplay').value = ''; // Clear previous letter
            }

            // Removed generateFutureSelfLetter as per user request
            // async generateFutureSelfLetter() {
            //     if (this.isLoading) return;
            //     this.isLoading = true;
            //     const generateLetterBtn = document.getElementById('generateFutureLetterBtn');
            //     const originalText = generateLetterBtn.innerHTML;

            //     UIUtil.setLoading(generateLetterBtn, true, 'ရေးသားနေပါသည်...');

            //     const combinedJournalText = document.getElementById('combinedJournalText').value;
            //     if (!combinedJournalText.trim()) {
            //         UIUtil.showModal('အနာဂတ်အတွက် စာရေးရန် ဂျာနယ်မှတ်တမ်း မရှိသေးပါ။', 'error');
            //         this.isLoading = false;
            //         UIUtil.setLoading(generateLetterBtn, false, originalText);
            //         return;
            //     }

            //     const futureLetterSection = document.getElementById('futureLetterSection');
            //     const futureLetterDisplay = document.getElementById('futureLetterDisplay');

            //     try {
            //         const apiKey = StorageUtil.load('geminiApiKey');
            //         if (!apiKey) {
            //             UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
            //             UIUtil.showSection('apiKeySection');
            //             return;
            //         }
            //         const letter = await GeminiAPI.fetchFutureSelfLetter(combinedJournalText, apiKey);
            //         futureLetterDisplay.value = letter;
            //         futureLetterSection.classList.remove('hidden');
            //         UIUtil.showModal("အနာဂတ်အတွက် စာ ရေးသားပြီးပါပြီ။", "success");

            //         // Save the generated letter to the current journal entry
            //         const date = document.getElementById('journalDate').value;
            //         const entries = StorageUtil.load('journalEntries') || [];
            //         const existingEntryIndex = entries.findIndex(entry => entry.date === date);
            //         if (existingEntryIndex > -1) {
            //             entries[existingEntryIndex].future_letter = letter;
            //             StorageUtil.save('journalEntries', entries);
            //         }

            //     } catch (error) {
            //         console.error('Error generating future self letter:', error);
            //         UIUtil.showModal(`အနာဂတ်အတွက် စာ ရေးသားရာတွင် ပြဿနာရှိခဲ့ပါသည်။: ${error.message}`, 'error');
            //     } finally {
            //         this.isLoading = false;
            //         UIUtil.setLoading(generateLetterBtn, false, originalText);
            //     }
            // }

            // Removed copyFutureLetter as per user request
            // copyFutureLetter() {
            //     const futureLetterDisplay = document.getElementById('futureLetterDisplay');
            //     if (futureLetterDisplay) {
            //         futureLetterDisplay.select();
            //         document.execCommand('copy');
            //         UIUtil.showModal("အနာဂတ်အတွက် စာသား ကူးယူပြီးပါပြီ။", "success");
            //     }
            // }

            copyJournalText() {
                const combinedJournalText = document.getElementById('combinedJournalText');
                combinedJournalText.select();
                document.execCommand('copy');
                UIUtil.showModal("စာသားအားလုံး ကူးယူပြီးပါပြီ။", "success");
            }

            exportToNotion() {
                const entries = StorageUtil.load('journalEntries');
                if (!entries || entries.length === 0) {
                    UIUtil.showModal("ထုတ်ယူရန် မှတ်တမ်းများ မရှိပါ။", "error");
                    return;
                }

                const currentDate = document.getElementById('journalDate').value;
                const currentDayEntry = entries.find(entry => entry.date === currentDate);

                let filename = `Journal_${currentDate}.md`;
                if (currentDayEntry && currentDayEntry.summary && currentDayEntry.summary.trim() !== '') {
                    let sanitizedSummary = currentDayEntry.summary.replace(/[/\\?%*:|"<>]/g, '').trim();
                    sanitizedSummary = sanitizedSummary.replace(/\s+/g, '_');
                    if (sanitizedSummary.length > 50) {
                        sanitizedSummary = sanitizedSummary.substring(0, 50);
                    }
                    if (sanitizedSummary) {
                        filename = `${sanitizedSummary}.md`;
                    }
                }
                
                let exportContent = `# နေ့စဉ်မှတ်တမ်းများ\n\n`;
                entries.sort((a, b) => new Date(a.date) - new Date(b.date)); 
                
                entries.forEach(entry => {
                    exportContent += `## ${entry.summary ? entry.summary : entry.date}\n\n`; 
                    exportContent += `**ရက်စွဲ:** ${entry.date}\n\n`;
                    
                    if (entry.mood && entry.mood.trim() !== '') {
                        exportContent += `**စိတ်ခံစားမှု:** ${entry.mood}\n\n`;
                    }

                    exportContent += `${entry.text}\n\n`;

                    if (entry.key_themes && entry.key_themes.length > 0) {
                        exportContent += `### အဓိက အကြောင်းအရာများ\n`;
                        entry.key_themes.forEach(theme => {
                            exportContent += `- ${theme}\n`;
                        });
                        exportContent += `\n`;
                    }

                    if (entry.action_items && entry.action_items.length > 0) {
                        exportContent += `### လုပ်ဆောင်ရမည့်အချက်များ\n`;
                        entry.action_items.forEach(item => {
                            exportContent += `- ${item}\n`;
                        });
                        exportContent += `\n`;
                    }

                    if (entry.affirmation && entry.affirmation.trim() !== '') {
                        exportContent += `### အားပေးစကား\n`;
                        exportContent += `> ${entry.affirmation}\n\n`;
                    }

                    // Removed future_letter from export content
                    // if (entry.future_letter && entry.future_letter.trim() !== '') {
                    //     exportContent += `### အနာဂတ်အတွက် စာ\n`;
                    //     exportContent += `> ${entry.future_letter}\n\n`;
                    // }

                    exportContent += `---\n\n`;
                });

                const blob = new Blob([exportContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                UIUtil.showModal("Notion အတွက် မှတ်တမ်းများ ထုတ်ယူပြီးပါပြီ။", "success");
                setTimeout(() => {
                    UIUtil.showModal("Notion ထဲသို့ ဖိုင်ကို ဆွဲထည့်ခြင်း (သို့) Import option မှတစ်ဆင့် ထည့်သွင်းနိုင်ပါသည်။", "success");
                }, 2500);
            }

            handleKeydown(event) {
                const promptsSection = document.getElementById('promptsSection');
                if (event.key === 'Tab' && !event.repeat && !promptsSection.classList.contains('hidden')) {
                    event.preventDefault();
                    const nextBtn = document.getElementById('nextPromptBtn');
                    const combineBtn = document.getElementById('combineAnswersBtn');
                    if (!nextBtn.classList.contains('hidden') && !nextBtn.disabled) {
                        nextBtn.click();
                    } else if (!combineBtn.classList.contains('hidden') && !combineBtn.disabled) {
                        combineBtn.click();
                    }
                }
            }

            displayRandomPhilosophy() {
                const philosophyTextElem = document.getElementById('philosophyText');
                const sourceCreditElem = document.getElementById('sourceCredit');
                const randomIndex = Math.floor(Math.random() * this.philosophyTexts.length);
                const selectedPhilosophy = this.philosophyTexts[randomIndex];
                philosophyTextElem.textContent = selectedPhilosophy.text;
                sourceCreditElem.textContent = selectedPhilosophy.credit;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new JournalApp();
        });
    </script>
</body>
</html>
