<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>နေ့စဉ်မှတ်တမ်း</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyidaungsu Font via Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font and global styles */
        :root {
            --primary-color: #1e40af;
            --primary-hover: #1d4ed8;
            --secondary-color: #6b7280;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --modal-background: rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Pyidaungsu', "Inter", sans-serif;
            background-color: var(--background-color);
            line-height: 1.6;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 768px;
            padding: 1rem;
            margin: 0 auto;
        }

        @media (min-width: 640px) {
            .container {
                padding: 1.5rem;
            }
        }

        .card {
            background-color: var(--card-background);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            animation: cardFadeIn 0.5s ease-out forwards;
        }

        @keyframes cardFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            text-decoration: none;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            min-width: 48px;
            min-height: 48px;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            transition: all 0.2s ease-in-out;
        }

        .btn:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #4b5563;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            background-color: var(--card-background);
            position: relative;
            transition: all 0.2s ease-in-out;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgb(59 130 246 / 0.3);
            transform: scale(1.01);
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 0.5rem;
            height: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.5s ease-in-out;
            border-radius: 0.5rem;
        }

        @media (max-width: 640px) {
            .progress-container {
                height: 0.75rem;
            }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 400px;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        @media (max-width: 640px) {
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0 1rem;
                padding: 1rem;
            }
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal.success .modal-content {
            border-left: 4px solid var(--success-color);
        }

        .modal.error .modal-content {
            border-left: 4px solid var(--error-color);
        }

        .prompt-display {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border: 2px solid #0ea5e9;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .prompt-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .prompt-display.prompt-transition::before {
            left: 100%;
        }

        .suggestion-card {
            background: linear-gradient(135deg, #f0fff4 0%, #f7fee7 100%);
            border: 2px solid #22c55e;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: scale(0.95);
            animation: suggestionFadeIn 0.5s ease-out forwards;
        }

        @keyframes suggestionFadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 640px) {
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                padding: 0.75rem;
            }

            .flex-wrap {
                flex-direction: column;
                align-items: stretch;
            }

            .text-4xl {
                font-size: clamp(1.5rem, 5vw, 2rem);
            }

            .text-2xl {
                font-size: clamp(1.25rem, 4vw, 1.5rem);
            }

            .text-xl {
                font-size: clamp(1rem, 3.5vw, 1.25rem);
            }

            .textarea-field {
                min-height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="text-4xl font-bold text-center text-blue-800 mb-8">နေ့စဉ်မှတ်တမ်း</h1>
            
            <!-- Main Content Area -->
            <div id="app-content" role="main">
                <!-- Privacy Policy Section -->
                <div id="privacySection" class="section hidden" aria-labelledby="privacy-title">
                    <h2 id="privacy-title" class="text-2xl font-bold text-center text-orange-700 mb-6">ကိုယ်ရေးအချက်အလက်ကာကွယ်မှု</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App သည် သုံးစွဲသူများ၏ ကိုယ်ရေးအချက်အလက် လုံခြုံရေးကို အလေးထားပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ အချက်အလက်သိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>သင့်၏ ဂျာနယ်မှတ်တမ်းများကို သင့် Browser ၏ Local Storage တွင်သာ သိမ်းဆည်းထားပါသည်။</li>
                                <li>မည်သည့် Server သို့မှ အချက်အလက်မျှ ပေးပို့ခြင်းမရှိပါ။</li>
                                <li>၎င်းသည် သင့်အချက်အလက်များကို သင့်ထိန်းချုပ်မှုအောက်တွင်သာ ရှိစေပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်ဖောက်ပြားမှု ကာကွယ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>အချက်အလက်များ Local Storage တွင်သာ ရှိသောကြောင့် ပြင်ပ Server များမှ ပေါက်ကြားနိုင်ခြေ မရှိပါ။</li>
                                <li>Browser Cache ရှင်းလင်းပါက မှတ်တမ်းများ ပျောက်ဆုံးနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ပြင်ပဝန်ဆောင်မှုများ</h3>
                            <ul class="list-disc list-inside space-y-2">
                                <li>Google Gemini API ကို သုံးသပ်ချက်ရယူရန်အတွက်သာ အသုံးပြုပါသည်။</li>
                                <li>သင့်ကိုယ်ရေးအချက်အလက်များကို သိမ်းဆည်းခြင်း မရှိပါ။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreePrivacyBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- Terms Section -->
                <div id="termsSection" class="section hidden" aria-labelledby="terms-title">
                    <h2 id="terms-title" class="text-2xl font-bold text-center text-yellow-700 mb-6">စည်းမျဉ်းနှင့် သတ်မှတ်ချက်များ</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App ကို အသုံးပြုခြင်းဖြင့် အောက်ပါ စည်းမျဉ်းများကို သဘောတူညီရာ ရောက်ပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ App အသုံးပြုခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ကိုယ်ပိုင် ဂျာနယ်မှတ်တမ်းရေးသားခြင်းအတွက်သာ အသုံးပြုရပါမည်။</li>
                                <li>မလျော်ကန်သော နည်းလမ်းများဖြင့် အသုံးပြုခြင်းကို တားမြစ်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်များ</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>မှတ်တမ်းများ ပျောက်ဆုံးခြင်းအတွက် App ဖန်တီးသူတွင် တာဝန်မရှိပါ။</li>
                                <li>အရေးကြီးသော မှတ်တမ်းများကို Backup လုပ်ထားရန် အကြံပြုပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ဝန်ဆောင်မှု</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ဤ App ကို "ရှိပြီးသားအတိုင်း" ပေးထားခြင်းဖြစ်ပြီး မည်သည့် အာမခံချက်မျှ မရှိပါ။</li>
                                <li>လုပ်ဆောင်ချက်များ အချိန်မရွေး ပြောင်းလဲနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreeTermsBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- User Guide Section -->
                <div id="guideSection" class="section hidden" aria-labelledby="guide-title">
                    <h2 id="guide-title" class="text-2xl font-bold text-center text-blue-700 mb-6">အသုံးပြုနည်းလမ်းညွှန်</h2>
                    <div class="space-y-6 text-gray-700">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ ဂျာနယ်စတင်ရေးသားခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>လက်ရှိရက်စွဲကို အလိုအလျောက် သတ်မှတ်ပေးထားပါသည်။</li>
                                <li>စိတ်ခံစားမှုကို ရွေးချယ်ပြီး "မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်" ကို နှိပ်ပါ။</li>
                                <li>မေးခွန်းတစ်ခုချင်းစီကို ဖြေကြားပြီး "နောက်မေးခွန်း" သို့ ရွှေ့ပါ။</li>
                                <li>ဖုန်းတွင် နှိပ်ရုံဖြင့်လည်း နောက်မေးခွန်းသို့ ရွှေ့နိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ မှတ်တမ်းသိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"အဖြေများ စုစည်းမည်" ကို နှိပ်လျှင် အလိုအလျောက် သိမ်းဆည်းပါသည်။</li>
                                <li>AI သုံးသပ်ချက်အချို့အရ အားပေးစကားများကို ထုတ်ပေးပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ Export လုပ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"Notion Markdown ထုတ်မည်" ကို နှိပ်ပြီး Markdown ဖိုင်ကို ရယူနိုင်ပါသည်။</li>
                                <li>ထိုဖိုင်ကို Notion သို့ Drag & Drop ဖြင့် တင်သွင်းနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="startJournalingBtn" class="btn btn-primary" aria-label="ဂျာနယ်စတင်ရေးမည်">ဂျာနယ်စတင်ရေးမည်</button>
                    </div>
                </div>

                <!-- API Key Input Section -->
                <div id="apiKeySection" class="section hidden" aria-labelledby="api-key-title">
                    <h2 id="api-key-title" class="text-2xl font-bold text-center text-blue-700 mb-6">Gemini API Key</h2>
                    <div class="space-y-4">
                        <p class="text-gray-600">သင်၏ဂျာနယ်မှတ်တမ်းများကို AI ဖြင့် သုံးသပ်ရန်အတွက် Google Gemini API Key လိုအပ်ပါသည်။</p>
                        <p class="text-sm text-gray-500">API Key ကို <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a> မှ ရယူနိုင်ပါသည်။</p>
                        <input type="password" id="apiKeyInput" class="input-field" placeholder="Enter your Gemini API Key" aria-label="Gemini API Key" required>
                        <div class="text-center">
                            <button id="saveApiKeyBtn" class="btn btn-primary" aria-label="သိမ်းမည်">သိမ်းမည်</button>
                        </div>
                    </div>
                </div>

                <!-- Main Journal Section -->
                <div id="journalSection" class="section hidden">
                    <!-- Date and Mood Selection -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="journalDate" class="block text-gray-700 font-medium mb-2">ရက်စွဲ:</label>
                            <input type="date" id="journalDate" class="input-field" aria-label="ရက်စွဲ ရွေးပါ" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">စိတ်ခံစားမှု:</label>
                            <select id="journalMood" class="input-field" aria-label="စိတ်ခံစားမှု ရွေးပါ" required>
                                <option value="">စိတ်ခံစားမှု ရွေးပါ</option>
                                <option value="ပျော်ရွှင်">ပျော်ရွှင် 😊</option>
                                <option value="ဝမ်းနည်း">ဝမ်းနည်း 😢</option>
                                <option value="စိတ်တို">စိတ်တို 😠</option>
                                <option value="စိတ်လှုပ်ရှား">စိတ်လှုပ်ရှား 🤩</option>
                                <option value="ငြိမ်သက်">ငြိမ်သက် 😌</option>
                                <option value="ပင်ပန်း">ပင်ပန်း 😴</option>
                                <option value="စိတ်ရှုပ်">စိတ်ရှုပ် 😕</option>
                                <option value="ကျေနပ်">ကျေနပ် 👍</option>
                            </select>
                        </div>
                    </div>

                    <!-- Life Reflection Philosophy -->
                    <div class="mt-6 bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h3 class="text-lg font-semibold text-blue-900">ဘဝဆိုင်ရာ တွေးတောမှု</h3>
                        <p id="philosophyText" class="text-blue-700"></p>
                        <p id="sourceCredit" class="text-xs text-blue-600 mt-2"></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="startPromptsBtn" class="btn btn-primary">
                            <span id="startPromptsBtnText">✨ မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်</span>
                        </button>
                        <button id="clearApiKeyBtn" class="btn btn-danger">API Key ဖယ်ရှားမည်</button>
                    </div>

                    <!-- Feedback Form -->
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">အကြံပြုချက်</h3>
                        <textarea id="feedbackTextarea" class="input-field textarea-field" placeholder="သင်၏ အကြံပြုချက်များကို ဤနေရာတွင် ရေးပါ" aria-label="အကြံပြုချက်"></textarea>
                        <div class="text-center mt-4">
                            <button id="submitFeedbackBtn" class="btn btn-success" aria-label="အကြံပြုချက် ပေးပို့မည်">အကြံပြုချက် ပေးပို့မည်</button>
                        </div>
                    </div>
                </div>

                <!-- Prompts Section -->
                <div id="promptsSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">ဂျာနယ်မေးခွန်းများ</h2>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="promptDisplay" class="prompt-display">
                        <p id="currentPromptText" class="text-lg font-medium text-blue-900 mb-4"></p>
                        <textarea id="promptAnswerTextarea" class="input-field textarea-field" placeholder="သင့်အဖြေကို ဤနေရာတွင် ရေးပါ" aria-label="မေးခွန်းအတွက် အဖြေ"></textarea>
                    </div>
                    <div class="flex justify-between gap-4">
                        <button id="prevPromptBtn" class="btn btn-secondary" disabled aria-label="ယခင်မေးခွန်း">ယခင်မေးခွန်း</button>
                        <span id="promptCounter" class="text-gray-600 self-center" aria-live="polite">1/5</span>
                        <button id="nextPromptBtn" class="btn btn-primary" aria-label="နောက်မေးခွန်း">နောက်မေးခွန်း</button>
                        <button id="combineAnswersBtn" class="btn btn-success hidden" aria-label="အဖြေများ စုစည်းမည်">အဖြေများ စုစည်းမည်</button>
                    </div>
                    <div class="text-center mt-6">
                        <button id="backToJournalBtn" class="btn btn-secondary" aria-label="ပင်မစာမျက်နှာသို့ ပြန်သွားမည်">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>

                <!-- Suggestions Section -->
                <div id="suggestionsSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">အကြံပြုချက်များ</h2>
                    <div id="affirmationDisplay" class="suggestion-card">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အားပေးစကား</h3>
                        <p id="affirmationText" class="text-gray-700"></p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ဂျာနယ်မှတ်တမ်း</h3>
                        <textarea id="combinedJournalText" class="input-field textarea-field" style="min-height: 300px;" readonly aria-label="ဂျာနယ်မှတ်တမ်း"></textarea>
                        <div class="flex justify-center gap-4 mt-4">
                            <button id="copyCombinedTextBtn" class="btn btn-success" aria-label="အားလုံးကူးယူမည်">အားလုံးကူးယူမည်</button>
                            <button id="exportToNotionBtn" class="btn btn-primary" aria-label="Notion Markdown ထုတ်မည်">Notion Markdown ထုတ်မည်</button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button id="backToMainJournalBtn" class="btn btn-secondary" aria-label="ပင်မစာမျက်နှာသို့ ပြန်သွားမည်">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
            <div class="modal-content">
                <button id="modalClose" class="modal-close" aria-label="ပိတ်မည်">×</button>
                <p id="modalMessage" class="text-center font-semibold"></p>
            </div>
        </div>
    </div>

    <script>
        // Fallback affirmations for different moods
        const FALLBACK_AFFIRMATIONS = {
            "ပျော်ရွှင်": [
                "သင့်ရဲ့ ပျော်ရွှင်မှုကို ဆက်လက်မျှဝေပြီး အခြားသူတွေကိုလည်း အားပေးပါ။",
                "ဒီပျော်ရွှင်မှုကို အမှတ်တရအဖြစ် သိမ်းထားပြီး နောက်ထပ်ထပ်ဖန်တီးပါ။"
            ],
            "ဝမ်းနည်း": [
                "သင်တစ်ယောက်တည်း မဟုတ်ပါဘူး။ စိတ်ခံစားမှုတွေကို လွတ်လပ်စွာ ဖော်ပြပြီး အားယူပါ။",
                "ဒီနေ့ သင့်ကိုယ်သင် ဂရုစိုက်ဖို့ အချိန်ပေးပါ။ အနည်းငယ်အနားယူခြင်းက အထောက်အကူပြုနိုင်ပါတယ်။"
            ],
            "စိတ်တို": [
                "စိတ်အေးအေးထားပြီး အသက်ရှူလေ့ကျင့်ခန်း လုပ်ကြည့်ပါ။ သင်ရဲ့စိတ်ကို ပြန်လည်ထိန်းချုပ်နိုင်ပါတယ်။",
                "သင့်ရဲ့စိတ်တိုမှုကို ရေးထုတ်ပြီး ဘာကြောင့်ဖြစ်ပေါ်လာလဲ ဆန်းစစ်ကြည့်ပါ။"
            ],
            "စိတ်လှုပ်ရှား": [
                "ဒီစိတ်လှုပ်ရှားမှုကို အသုံးချပြီး သင့်ရဲ့ရည်မှန်းချက်တွေကို အကောင်အထည်ဖော်ပါ။",
                "ဒီစိတ်လှုပ်ရှားမှုကို အခြားသူတွေနဲ့ မျှဝေပြီး အကောင်းမြင်စိတ်ကို ဖြန့်ဝေပါ။"
            ],
            "ငြိမ်သက်": [
                "ဒီငြိမ်သက်မှုကို ဆက်လက်ထိန်းသိမ်းပြီး သင့်ရဲ့စိတ်ကို အာရုံစူးစိုက်မှု ပေးပါ။",
                "ဒီအခိုက်အတန့်ကို အပြည့်အဝခံစားပြီး ကိုယ့်ကိုယ်ကို အားဖြည့်ပါ။"
            ],
            "ပင်ပန်း": [
                "သင့်ကိုယ်သင် အနားပေးဖို့ အချိန်ယူပါ။ အနည်းငယ်အနားယူခြင်းက အံ့သြဖွယ်ဖြစ်စေနိုင်ပါတယ်။",
                "ဒီနေ့ သင်လုပ်ဆောင်ခဲ့တာတွေကို ဂုဏ်ယူပြီး အနားယူဖို့ အချိန်ပေးပါ။"
            ],
            "စိတ်ရှုပ်": [
                "အသက်ရှူလေ့ကျင့်ခန်း လုပ်ပြီး သင့်ရဲ့အတွေးတွေကို စီစဉ်ကြည့်ပါ။",
                "သင့်ရဲ့စိတ်ရှုပ်မှုကို တစ်ခုချင်း ဖြေရှင်းဖို့ အသေးစိတ်စီစဉ်ပါ။"
            ],
            "ကျေနပ်": [
                "ဒီကျေနပ်မှုကို ဆက်လက်ထိန်းသိမ်းပြီး နောက်ထပ်အောင်မြင်မှုတွေကို ဖန်တီးပါ။",
                "သင့်ရဲ့အောင်မြင်မှုတွေကို ဂုဏ်ယူပြီး နောက်ထပ်ပန်းတိုင်တွေ ချမှတ်ပါ။"
            ]
        };

        // Utility module for localStorage operations
        const StorageUtil = {
            // Save data to localStorage with error handling
            save(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Error saving ${key}: ${e.message}`);
                    return false;
                }
            },
            // Load data from localStorage with error handling
            load(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error(`Error loading ${key}: ${e.message}`);
                    return null;
                }
            },
            // Remove data from localStorage
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error(`Error removing ${key}: ${e.message}`);
                    return false;
                }
            }
        };

        // API module for Gemini API interactions
        const GeminiAPI = {
            // Fetch journaling prompts based on mood
            async fetchPrompts(mood, apiKey) {
                const prompt = mood
                    ? `Generate 5 distinct journaling prompts in Burmese, suitable for someone experiencing a '${mood}' mood. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`
                    : `Generate 5 journaling prompts in Burmese. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`;
                return this._makeApiCall(prompt, { type: 'ARRAY', items: { type: 'STRING' } }, apiKey, "gemini-2.0-flash");
            },

            // Fetch affirmation based on journal text and mood
            async fetchAffirmation(journalText, mood, apiKey) {
                const prompt = `Analyze the following journal entry in Burmese:\n\n${journalText}\n\nMood: ${mood}\n\nProvide a positive affirmation in Burmese based on the journal entry and mood. The affirmation should be motivational, concise, and relevant. Return a JSON response: {"affirmation": "A positive affirmation in Burmese."}`;
                return this._makeApiCall(prompt, {
                    type: 'OBJECT',
                    properties: { affirmation: { type: 'STRING' } },
                    required: ['affirmation']
                }, apiKey, "gemini-2.0-flash");
            },

            // Generic API call with error handling
            async _makeApiCall(prompt, schema, apiKey, model = "gemini-2.0-flash", responseMimeType = "application/json") {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
                const payload = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: schema ? { responseMimeType: responseMimeType, responseSchema: schema } : { responseMimeType: responseMimeType },
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                        ]
                    })
                };

                try {
                    const response = await fetch(apiUrl, payload);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMsg = errorData?.error?.message || response.statusText;
                        if (response.status === 403) {
                            throw new Error(`API Key မှားယွင်းနေပါသည်။ ကျေးဇူးပြု၍ Google AI Studio (https://aistudio.google.com/app/apikey) မှ မှန်ကန်သော API Key ကို ထည့်သွင်းပေးပါ။`);
                        } else if (response.status === 429) {
                            throw new Error(`သင့် API အသုံးပြုမှု ကန့်သတ်ချက် ပြည့်နေပါပြီ။ ကျေးဇူးပြု၍ Google AI Studio (https://aistudio.google.com/app/apikey) တွင် သင့် Plan နှင့် Billing အချက်အလက်များကို စစ်ဆေးပါ။`);
                        } else if (response.status === 503) {
                            throw new Error(`AI Model အလုပ်များနေပါသည်။ ခဏစောင့်ပြီး ပြန်လည်ကြိုးစားကြည့်ပါ။`);
                        } else {
                            throw new Error(`API ချိတ်ဆက်မှု ပြဿနာရှိခဲ့ပါသည်။ Status: ${response.status} ${errorMsg}`);
                        }
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return JSON.parse(result.candidates[0].content.parts[0].text);
                    }
                    throw new Error('Unexpected API response structure.');
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        };

        // Suggestion module for generating affirmations
        const SuggestionModule = {
            async generateAffirmation(journalText, mood, apiKey) {
                if (!journalText || journalText.trim() === "") {
                    return { affirmation: null, error: "ဂျာနယ်မှတ်တမ်း ဗလာဖြစ်နေပါသည်။" };
                }
                try {
                    const result = await GeminiAPI.fetchAffirmation(journalText, mood, apiKey);
                    return { affirmation: result.affirmation, error: null };
                } catch (error) {
                    console.error("Error generating affirmation:", error);
                    const fallback = FALLBACK_AFFIRMATIONS[mood]?.[Math.floor(Math.random() * FALLBACK_AFFIRMATIONS[mood].length)] || "သင့်ကိုယ်သင် ယုံကြည်မှုထားပါ၊ သင်သည် အရာအားလုံးကို ကျော်လွှားနိုင်ပါသည်။";
                    return { affirmation: fallback, error: error.message };
                }
            }
        };

        // UI utility module
        const UIUtil = {
            // Show specific section and hide others
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    setTimeout(() => targetSection.classList.add('active'), 50);
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                    targetSection.focus();
                }
            },

            // Show modal with message and type
            showModal(message, type = 'success') {
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modalMessage');
                modalMessage.textContent = message;
                modal.className = `modal show ${type}`;
                modal.focus();
                setTimeout(() => this.hideModal(), 3000);
            },

            // Hide modal
            hideModal() {
                const modal = document.getElementById('modal');
                modal.classList.remove('show', 'success', 'error');
            },

            // Set loading state for buttons
            setLoading(element, isLoading, originalText = '', spinnerHtml = '<span class="loading-spinner"></span>') {
                if (isLoading) {
                    element.disabled = true;
                    element.innerHTML = spinnerHtml + originalText;
                } else {
                    element.disabled = false;
                    element.innerHTML = originalText;
                }
            },

            // Update progress bar
            updateProgressBar(current, total) {
                const progressBar = document.getElementById('progressBar');
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            }
        };

        // Main Journal App Class
        class JournalApp {
            constructor() {
                this.currentPromptIndex = 0;
                this.promptAnswers = [];
                this.activePrompts = [];
                this.defaultPrompts = [
                    "ဒီနေ့အတွက် ကျေးဇူးတင်စရာ ဘာတွေရှိလဲ။",
                    "ဒီနေ့ ဘယ်အရာက သင့်ကို ပျော်ရွှင်စေခဲ့လဲ။",
                    "ဒီနေ့ သင်ယူခဲ့ရတဲ့ အရာတစ်ခုခု ရှိလား။",
                    "ဒီနေ့ ဘယ်လို စိတ်ခံစားမှုမျိုး ခံစားခဲ့ရလဲ။ ဘာကြောင့်လဲ။",
                    "ကိုယ့်ကိုယ်ကို ပိုကောင်းအောင် ဘာတွေ လုပ်နိုင်ခဲ့လဲ။"
                ];
                this.isLoading = false;
                this.philosophyTexts = [
                    {
                        text: "တစ်နေ့တာ ၁၀ မိနစ်လောက် ကိုယ့်ကိုယ်ကို ပြန်သုံးသပ်တဲ့အချိန်ပေးတာက ဘဝတိုးတက်ဖို့အတွက် အရေးကြီးဆုံးအရာတွေထဲက တစ်ခုပါပဲ။",
                        credit: "Credit: KO LAPYAE"
                    },
                    {
                        text: "နေ့စဉ် ဂျာနယ်ရေးသားခြင်းသည် မိမိကိုယ်ကို ပိုမိုနားလည်စေပြီး စိတ်ဖိစီးမှုများကို လျှော့ချကာ စိတ်ပိုင်းဆိုင်ရာ ကျန်းမာရေးကို မြှင့်တင်ပေးသည်။",
                        credit: "Source: Journaling for Mental Health"
                    }
                ];
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkInitialState();
                this.displayRandomPhilosophy();
            }

            bindEvents() {
                // Initial flow buttons
                document.getElementById('agreePrivacyBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToPrivacy', 'true');
                    UIUtil.showSection('termsSection');
                });
                document.getElementById('agreeTermsBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToTerms', 'true');
                    UIUtil.showSection('guideSection');
                });
                document.getElementById('startJournalingBtn').addEventListener('click', () => this.promptForApiKeyOrStartJournaling());

                // API Key management
                document.getElementById('saveApiKeyBtn').addEventListener('click', () => this.saveApiKey());
                document.getElementById('clearApiKeyBtn').addEventListener('click', () => this.clearApiKey());

                // Journal section buttons
                document.getElementById('startPromptsBtn').addEventListener('click', () => this.startPrompts());
                document.getElementById('submitFeedbackBtn').addEventListener('click', () => this.submitFeedback());

                // Prompts section buttons
                document.getElementById('prevPromptBtn').addEventListener('click', () => this.previousPrompt());
                document.getElementById('nextPromptBtn').addEventListener('click', () => this.nextPrompt());
                document.getElementById('combineAnswersBtn').addEventListener('click', () => this.combineAnswers());
                document.getElementById('backToJournalBtn').addEventListener('click', () => this.showJournalSection());

                // Suggestions section buttons
                document.getElementById('copyCombinedTextBtn').addEventListener('click', () => this.copyJournalText());
                document.getElementById('exportToNotionBtn').addEventListener('click', () => this.exportToNotion());
                document.getElementById('backToMainJournalBtn').addEventListener('click', () => this.showJournalSection());

                // Modal close button
                document.getElementById('modalClose').addEventListener('click', () => UIUtil.hideModal());

                // Global keyboard events
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
            }

            checkInitialState() {
                const agreedToPrivacy = StorageUtil.load('agreedToPrivacy');
                const agreedToTerms = StorageUtil.load('agreedToTerms');
                const hasApiKey = StorageUtil.load('geminiApiKey');

                if (!agreedToPrivacy) {
                    UIUtil.showSection('privacySection');
                } else if (!agreedToTerms) {
                    UIUtil.showSection('termsSection');
                } else if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            showJournalSection() {
                UIUtil.showSection('journalSection');
                this.setTodayDate();
                document.getElementById('journalMood').value = "";
                this.displayRandomPhilosophy();
            }

            setTodayDate() {
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                document.getElementById('journalDate').value = dateString;
            }

            saveApiKey() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (!apiKey) {
                    UIUtil.showModal('API Key ထည့်သွင်းပါ။', 'error');
                    return;
                }
                StorageUtil.save('geminiApiKey', apiKey);
                UIUtil.showModal('API Key သိမ်းဆည်းပြီးပါပြီ။', 'success');
                this.showJournalSection();
            }

            clearApiKey() {
                StorageUtil.remove('geminiApiKey');
                document.getElementById('apiKeyInput').value = '';
                UIUtil.showModal('API Key ဖျက်လိုက်ပါပြီ။', 'success');
                UIUtil.showSection('apiKeySection');
            }

            submitFeedback() {
                const feedbackText = document.getElementById('feedbackTextarea').value.trim();
                if (!feedbackText) {
                    UIUtil.showModal('အကြံပြုချက် ထည့်သွင်းပါ။', 'error');
                    return;
                }
                const feedbackEntry = {
                    text: feedbackText,
                    timestamp: new Date().toISOString()
                };
                const feedbacks = StorageUtil.load('feedbacks') || [];
                feedbacks.push(feedbackEntry);
                StorageUtil.save('feedbacks', feedbacks);
                document.getElementById('feedbackTextarea').value = '';
                UIUtil.showModal('အကြံပြုချက် ပေးပို့ပြီးပါပြီ။', 'success');
            }

            promptForApiKeyOrStartJournaling() {
                const hasApiKey = StorageUtil.load('geminiApiKey');
                if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            async startPrompts() {
                if (this.isLoading) return;
                const startPromptsBtn = document.getElementById('startPromptsBtn');
                const originalText = startPromptsBtn.innerHTML;

                UIUtil.setLoading(startPromptsBtn, true, 'ဖန်တီးနေပါသည်...');
                this.isLoading = true;

                try {
                    const selectedMood = document.getElementById('journalMood').value;
                    if (!selectedMood) {
                        UIUtil.showModal('စိတ်ခံစားမှုကို ရွေးချယ်ပေးပါ။', 'error');
                        return;
                    }
                    const apiKey = StorageUtil.load('geminiApiKey');
                    if (!apiKey) {
                        UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
                        UIUtil.showSection('apiKeySection');
                        return;
                    }

                    this.activePrompts = await GeminiAPI.fetchPrompts(selectedMood, apiKey);
                    this.currentPromptIndex = 0;
                    this.promptAnswers = Array(this.activePrompts.length).fill('');
                    this.displayCurrentPrompt();
                    UIUtil.showSection('promptsSection');
                } catch (error) {
                    console.error('Error starting prompts:', error);
                    UIUtil.showModal(`မေးခွန်းများ ရယူရာတွင် ပြဿနာရှိခဲ့ပါသည်။: ${error.message}`, 'error');
                    this.activePrompts = [...this.defaultPrompts];
                    this.currentPromptIndex = 0;
                    this.promptAnswers = Array(this.activePrompts.length).fill('');
                    this.displayCurrentPrompt();
                    UIUtil.showSection('promptsSection');
                } finally {
                    this.isLoading = false;
                    UIUtil.setLoading(startPromptsBtn, false, originalText);
                }
            }

            displayCurrentPrompt() {
                const promptTextElem = document.getElementById('currentPromptText');
                const answerTextarea = document.getElementById('promptAnswerTextarea');
                const counterElem = document.getElementById('promptCounter');
                const prevBtn = document.getElementById('prevPromptBtn');
                const nextBtn = document.getElementById('nextPromptBtn');
                const combineBtn = document.getElementById('combineAnswersBtn');
                const promptDisplay = document.getElementById('promptDisplay');

                promptDisplay.classList.add('prompt-transition');
                setTimeout(() => {
                    promptTextElem.textContent = `${this.currentPromptIndex + 1}. ${this.activePrompts[this.currentPromptIndex]}`;
                    answerTextarea.value = this.promptAnswers[this.currentPromptIndex];
                    answerTextarea.focus();
                    counterElem.textContent = `${this.currentPromptIndex + 1}/${this.activePrompts.length}`;
                    prevBtn.disabled = (this.currentPromptIndex === 0);

                    if (this.currentPromptIndex === this.activePrompts.length - 1) {
                        nextBtn.classList.add('hidden');
                        combineBtn.classList.remove('hidden');
                    } else {
                        nextBtn.classList.remove('hidden');
                        combineBtn.classList.add('hidden');
                    }
                    UIUtil.updateProgressBar(this.currentPromptIndex + 1, this.activePrompts.length);
                    promptDisplay.classList.remove('prompt-transition');
                }, 200);
            }

            previousPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                this.currentPromptIndex--;
                this.displayCurrentPrompt();
            }

            nextPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                this.currentPromptIndex++;
                this.displayCurrentPrompt();
            }

            async combineAnswers() {
                if (this.isLoading) return;
                this.isLoading = true;
                UIUtil.showModal('အဖြေများ စုစည်းပြီး အကြံပြုချက် ရယူနေပါသည်။ ခဏစောင့်ပါ�।', 'success');

                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();

                const combinedText = this.promptAnswers
                    .map((answer, index) => {
                        if (answer) {
                            return `${index + 1}. ${this.activePrompts[index]}\nအဖြေ: ${answer}`;
                        }
                        return '';
                    })
                    .filter(item => item !== '')
                    .join('\n\n---\n\n');

                document.getElementById('combinedJournalText').value = combinedText;

                const date = document.getElementById('journalDate').value;
                const mood = document.getElementById('journalMood').value;

                try {
                    const apiKey = StorageUtil.load('geminiApiKey');
                    if (!apiKey) {
                        UIUtil.showModal('API Key မရှိသေးပါ။ ကျေးဇူးပြု၍ API Key ထည့်သွင်းပေးပါ။', 'error');
                        UIUtil.showSection('apiKeySection');
                        return;
                    }
                    const suggestionResult = await SuggestionModule.generateAffirmation(combinedText, mood, apiKey);

                    const newEntry = {
                        date,
                        mood,
                        text: combinedText,
                        affirmation: suggestionResult.affirmation
                    };
