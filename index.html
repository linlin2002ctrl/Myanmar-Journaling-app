<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>နေ့စဉ်မှတ်တမ်း</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pyidaungsu Font Integration via Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');

        /* Custom font and global styles */
        :root {
            --primary-color: #1e40af;
            --primary-hover: #1d4ed8;
            --secondary-color: #6b7280;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --modal-background: rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Pyidaungsu', "Inter", sans-serif;
            background-color: var(--background-color);
            line-height: 1.6;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 768px;
            padding: 1rem;
            margin: 0 auto;
        }

        @media (min-width: 640px) {
            .container {
                padding: 1.5rem;
            }
        }

        .card {
            background-color: var(--card-background);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            animation: cardFadeIn 0.5s ease-out forwards;
        }

        @keyframes cardFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            text-decoration: none;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            min-width: 48px;
            min-height: 48px;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }

        .btn:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #4b5563;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #059669;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: clamp(0.875rem, 2.5vw, 1rem);
            background-color: var(--card-background);
            position: relative;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgb(59 130 246 / 0.3);
            transform: scale(1.01);
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 0.5rem;
            height: 0.5rem;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.5s ease-in-out;
            border-radius: 0.5rem;
        }

        @media (max-width: 640px) {
            .progress-container {
                height: 0.75rem;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-background);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 400px;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        @media (max-width: 640px) {
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0 1rem;
                padding: 1rem;
            }
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal.success .modal-content {
            border-left: 4px solid var(--success-color);
        }

        .modal.error .modal-content {
            border-left: 4px solid var(--error-color);
        }

        /* Prompt Display */
        .prompt-display {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border: 2px solid #0ea5e9;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .prompt-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .prompt-display.prompt-transition::before {
            left: 100%;
        }

        /* Analysis Section */
        .analysis-section {
            background: linear-gradient(135deg, #f0fff4 0%, #f7fee7 100%);
            border: 2px solid #22c55e;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: scale(0.95);
            animation: analysisFadeIn 0.5s ease-out forwards;
        }

        @keyframes analysisFadeIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .analysis-section:nth-child(1) { animation-delay: 0.1s; }
        .analysis-section:nth-child(2) { animation-delay: 0.2s; }
        .analysis-section:nth-child(3) { animation-delay: 0.3s; }
        .analysis-section:nth-child(4) { animation-delay: 0.4s; }

        .hidden {
            display: none !important;
        }

        /* Mobile-Specific Adjustments */
        @media (max-width: 640px) {
            .grid-cols-1 {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                padding: 0.75rem;
            }

            .flex-wrap {
                flex-direction: column;
                align-items: stretch;
            }

            .text-4xl {
                font-size: clamp(1.5rem, 5vw, 2rem);
            }

            .text-2xl {
                font-size: clamp(1.25rem, 4vw, 1.5rem);
            }

            .text-xl {
                font-size: clamp(1rem, 3.5vw, 1.25rem);
            }

            .textarea-field {
                min-height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="text-4xl font-bold text-center text-blue-800 mb-8">နေ့စဉ်မှတ်တမ်း</h1>
            
            <!-- Main Content Area -->
            <div id="app-content" role="main">
                <!-- Privacy Policy Section -->
                <div id="privacySection" class="section hidden" aria-labelledby="privacy-title">
                    <h2 id="privacy-title" class="text-2xl font-bold text-center text-orange-700 mb-6">ကိုယ်ရေးအချက်အလက်ကာကွယ်မှု</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App သည် သုံးစွဲသူများ၏ ကိုယ်ရေးအချက်အလက် လုံခြံုရေးကို အလေးထားပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ အချက်အလက်သိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>သင့်၏ ဂျာနယ်မှတ်တမ်းများကို သင့် Browser ၏ Local Storage တွင်သာ သိမ်းဆည်းထားပါသည်။</li>
                                <li>မည်သည့် Server သို့မှ အချက်အလက်မျှ ပေးပို့ခြင်းမရှိပါ။</li>
                                <li>၎င်းသည် သင့်အချက်အလက်များကို သင့်ထိန်းချုပ်မှုအောက်တွင်သာ ရှိစေပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်ဖောက်ပြားမှု ကာကွယ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>အချက်အလက်များ Local Storage တွင်သာ ရှိသောကြောင့် ပြင်ပ Server များမှ ပေါက်ကြားနိုင်ခြေ မရှိပါ။</li>
                                <li>Browser Cache ရှင်းလင်းပါက မှတ်တမ်းများ ပျောက်ဆုံးနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ပြင်ပဝန်ဆောင်မှုများ</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>Google Gemini API ကို သုံးသပ်ချက်ရယူရန်အတွက်သာ အသုံးပြုပါသည်။</li>
                                <li>သင့်ကိုယ်ရေးအချက်အလက်များကို သိမ်းဆည်းခြင်း မရှိပါ။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreePrivacyBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- Terms Section -->
                <div id="termsSection" class="section hidden" aria-labelledby="terms-title">
                    <h2 id="terms-title" class="text-2xl font-bold text-center text-yellow-700 mb-6">စည်းမျဉ်းနှင့် သတ်မှတ်ချက်များ</h2>
                    <div class="space-y-4 text-gray-700">
                        <p>ဤ နေ့စဉ်မှတ်တမ်း App ကို အသုံးပြုခြင်းဖြင့် အောက်ပါ စည်းမျဉ်းများကို သဘောတူညီရာ ရောက်ပါသည်။</p>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ App အသုံးပြုခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ကိုယ်ပိုင် ဂျာနယ်မှတ်တမ်းရေးသားခြင်းအတွက်သာ အသုံးပြုရပါမည်။</li>
                                <li>မလျော်ကန်သော နည်းလမ်းများဖြင့် အသုံးပြုခြင်းကို တားမြစ်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ အချက်အလက်များ</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>မှတ်တမ်းများ ပျောက်ဆုံးခြင်းအတွက် App ဖန်တီးသူတွင် တာဝန်မရှိပါ။</li>
                                <li>အရေးကြီးသော မှတ်တမ်းများကို Backup လုပ်ထားရန် အကြံပြုပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ ဝန်ဆောင်မှု</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>ဤ App ကို "ရှိပြီးသားအတိုင်း" ပေးထားခြင်းဖြစ်ပြီး အာမခံချက် မရှိပါ။</li>
                                <li>လုပ်ဆောင်ချက်များ အချိန်မရွေး ပြောင်းလဲနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="agreeTermsBtn" class="btn btn-primary" aria-label="သဘောတူသည်">သဘောတူသည်</button>
                    </div>
                </div>

                <!-- User Guide Section -->
                <div id="guideSection" class="section hidden" aria-labelledby="guide-title">
                    <h2 id="guide-title" class="text-2xl font-bold text-center text-blue-700 mb-6">အသုံးပြုနည်းလမ်းညွှန်</h2>
                    <div class="space-y-6 text-gray-700">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၁။ ဂျာနယ်စတင်ရေးသားခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>လက်ရှိရက်စွဲကို အလိုအလျောက် သတ်မှတ်ပေးထားပါသည်။</li>
                                <li>စိတ်ခံစားမှုကို ရွေးချယ်ပြီး "မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်" ကို နှိပ်ပါ။</li>
                                <li>မေးခွန်းတစ်ခုချင်းစီကို ဖြေကြားပြီး "နောက်မေးခွန်း" သို့ ရွှေ့ပါ။</li>
                                <li>ဖုန်းတွင် နှိပ်ရုံဖြင့်လည်း နောက်မေးခွန်းသို့ ရွှေ့နိုင်ပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၂။ မှတ်တမ်းသိမ်းဆည်းခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"အဖြေများ စုစည်းမည်" ကို နှိပ်လျှင် အလိုအလျောက် သိမ်းဆည်းပါသည်။</li>
                                <li>AI သုံးသပ်ချက်အချို့အရ အဓိကအကြောင်းအရာများနှင့် လုပ်ဆောင်ရမည့်အချက်များကို ထုတ်ပေးပါသည်။</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">၃။ Export လုပ်ခြင်း</h3>
                            <ul class="list-disc list-inside space-y-1 ml-4">
                                <li>"Notion Markdown ထုတ်မည်" ကို နှိပ်ပြီး Markdown ဖိုင်ကို ရယူနိုင်ပါသည်။</li>
                                <li>ထိုဖိုင်ကို Notion သို့ Drag & Drop ဖြင့် တင်သွင်းနိုင်ပါသည်။</li>
                            </ul>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <button id="startJournalingBtn" class="btn btn-primary" aria-label="ဂျာနယ်စတင်ရေးမည်">ဂျာနယ်စတင်ရေးမည်</button>
                    </div>
                </div>

                <!-- API Key Input Section -->
                <div id="apiKeySection" class="section hidden" aria-labelledby="api-key-title">
                    <h2 id="api-key-title" class="text-2xl font-bold text-center text-blue-700 mb-6">Gemini API Key</h2>
                    <div class="space-y-4">
                        <p class="text-gray-600">သင်၏ဂျာနယ်မှတ်တမ်းများကို AI ဖြင့် သုံးသပ်ရန်အတွက် Google Gemini API Key လိုအပ်ပါသည်။</p>
                        <p class="text-sm text-gray-500">API Key ကို <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a> မှ ရယူနိုင်ပါသည်။</p>
                        <input type="password" id="apiKeyInput" class="input-field" placeholder="Enter your Gemini API Key" aria-label="Gemini API Key" required>
                        <div class="text-center">
                            <button id="saveApiKeyBtn" class="btn btn-primary" aria-label="သိမ်းမည်">သိမ်းမည်</button>
                        </div>
                    </div>
                </div>

                <!-- Main Journal Section -->
                <div id="journalSection" class="section hidden">
                    <!-- Date and Mood Selection -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="journalDate" class="block text-gray-700 font-medium mb-2">ရက်စွဲ:</label>
                            <input type="date" id="journalDate" class="input-field" aria-label="ရက်စွဲ ရွေးပါ" required>
                        </div>
                        <div>
                            <label for="journalMood" class="block text-gray-700 font-medium mb-2">စိတ်ခံစားမှု:</label>
                            <select id="journalMood" class="input-field" aria-label="စိတ်ခံစားမှု ရွေးပါ" required>
                                <option value="">စိတ်ခံစားမှု ရွေးပါ</option>
                                <option value="😊">😊 ပျော်ရွှင်မှု</option>
                                <option value="😢">😢 ဝမ်းနည်းမှု</option>
                                <option value="😄">😄 စိတ်လှုပ်ရှားမှု</option>
                                <option value="🤩">🤩 အံ့သြမှု</option>
                                <option value="😌">😌 အေးချမ်းမှု</option>
                                <option value="😴">😴 ပင်ပန်းမှု</option>
                                <option value="😕">😕 စိတ်ရှုပ်ထွေးမှု</option>
                                <option value="👍">👍 အောင်မြင်မှု</option>
                            </select>
                        </div>
                    </div>

                    <!-- Life Reflection Philosophy -->
                    <div class="mt-6 bg-blue-100 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <h3 class="text-lg font-semibold text-blue-900">ဘဝဆိုင်ရာ တွေးတောမှု</h3>
                        <p id="philosophyText" class="text-blue-700"></p>
                        <p id="sourceCredit" class="text-xs text-blue-600 mt-2"></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="startPromptsBtn" class="btn btn-primary">မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်</button>
                        <button id="clearApiKeyBtn" class="btn btn-danger">API Key ဖယ်ရှားမည်</button>
                    </div>
                </div>

                <!-- Prompts Section -->
                <div id="promptsSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">ဂျာနယ်မေးခွန်းများ</h2>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="promptDisplay" class="prompt-display">
                        <p id="currentPromptText" class="text-lg font-medium text-blue-900 mb-4"></p>
                        <textarea id="promptAnswerTextarea" class="input-field textarea-field" placeholder="သင့်အဖြေကို ဤနေရာတွင် ရေးပါ" aria-label="မေးခွန်းအတွက် အဖြေ"></textarea>
                    </div>
                    <div class="flex justify-between gap-4">
                        <button id="prevPromptBtn" class="btn btn-secondary" disabled>ယခင်မေးခွန်း</button>
                        <span id="promptCounter" class="text-gray-600 self-center" aria-live="polite">1/5</span>
                        <button id="nextPromptBtn" class="btn btn-primary">နောက်မေးခွန်း</button>
                        <button id="combineAnswersBtn" class="btn btn-success hidden">အဖြေများ စုစည်းမည်</button>
                    </div>
                    <div class="text-center mt-6">
                        <button id="backToJournalBtn" class="btn btn-secondary">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>

                <!-- Analysis Results Section -->
                <div id="analysisSection" class="section hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-900 mb-6">သုံးသပ်ချက်နှင့် ရလဒ်များ</h2>
                    <!-- Summary -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အနှစ်ချုပ်</h3>
                        <p id="analysisSummary" class="text-gray-700"></p>
                    </div>
                    <!-- Key Themes -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အဓိကအကြောင်းအရာများ</h3>
                        <ul id="keyThemesList" class="list-disc list-inside text-gray-700"></ul>
                    </div>
                    <!-- Action Items -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">လုပ်ဆောင်ရမည့်အချက်များ</h3>
                        <ul id="actionItemsList" class="list-disc list-inside text-gray-700"></ul>
                    </div>
                    <!-- Affirmation -->
                    <div class="analysis-section">
                        <h3 class="text-lg font-semibold text-blue-900 mb-2">အားပေးစကား</h3>
                        <p id="affirmationDisplay" class="text-gray-700"></p>
                    </div>
                    <!-- Journal Text -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">ဂျာနယ်မှတ်တမ်း</h3>
                        <textarea id="combinedJournalText" class="input-field textarea-field" style="min-height: 300px;" readonly></textarea>
                        <div class="flex justify-center gap-4 mt-4">
                            <button id="copyBtn" class="btn btn-success">အားလုံးကူးယူမည်</button>
                            <button id="exportBtn" class="btn btn-primary">Notion Markdown ထုတ်မည်</button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button id="backToMainJournalBtn" class="btn btn-secondary">ပင်မစာမျက်နှာသို့ ပြန်သွားမည်</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal" class="modal" role="dialog">
            <div class="modal-content">
                <button id="modalClose" class="modal-close" aria-label="ပိတ်မည်">×</button>
                <p id="modalMessage"></p>
            </div>
        </div>
    </div>

    <script>
        // Utility module for localStorage operations
        const StorageUtil = {
            save(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Error saving ${key}: ${e.message}`);
                    return false;
                }
            },
            load(key) {
                try {
                    const value = localStorage.getItem(key);
                    return value ? JSON.parse(value) : null;
                } catch (e) {
                    console.error(`Error loading ${key}: ${e.message}`);
                    return null;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.error(`Error removing ${key}: ${e.message}`);
                    return false;
                }
            }
        };

        // API module for Gemini API interactions
        const GeminiAPI = {
            async fetchPrompts(mood, apiKey) {
                const prompt = mood 
                    ? `Generate 5 distinct journaling prompts in Burmese, suitable for someone experiencing a '${mood}' mood. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].` 
                    : `Generate 5 journaling prompts in Burmese. All prompts must be in Burmese language only. Format: JSON array of strings, e.g., ["prompt1", "prompt2", ..., "prompt5"].`;

                return this._makeApiCall(prompt, { type: 'ARRAY', items: { type: 'STRING' } }, apiKey);
            },

            async fetchAnalysis(journalText, mood, apiKey) {
                const prompt = `Analyze the following journal entry in Burmese:\n\n${journalText}\n\nMood: ${mood}\n\nAll responses must be in Burmese language only. Provide a JSON response with the following structure:\n{\n  "summary": "A brief summary of the journal entry in Burmese.",\n  "themes": ["theme1 in Burmese", "theme2 in Burmese", "theme3 in Burmese"],\n  "actions": ["action1 in Burmese", "action2 in Burmese"],\n  "affirmation": "A positive affirmation based on the entry in Burmese."\n}`;

                return this._makeApiCall(prompt, {
                    type: 'OBJECT',
                    properties: {
                        summary: { type: 'STRING' },
                        themes: { type: 'ARRAY', items: { type: 'STRING' } },
                        actions: { type: 'ARRAY', items: { type: 'STRING' } },
                        affirmation: { type: 'STRING' }
                    },
                    required: ['summary', 'themes', 'actions', 'affirmation']
                }, apiKey);
            },

            async _makeApiCall(prompt, schema, apiKey) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${encodeURIComponent(apiKey)}`;
                const payload = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            response_mime_type: 'application/json',
                            response_schema: schema
                        },
                        safetySettings: [
                            { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                            { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                        ]
                    })
                };

                try {
                    const response = await fetch(apiUrl, payload);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMsg = errorData?.error?.message || response.statusText;
                        if (response.status === 403) {
                            throw new Error(`Invalid API key. Please check your key: ${errorMsg}`);
                        } else if (response.status === 429) {
                            throw new Error(`API quota exceeded. Check your plan at https://aistudio.google.com/app/apikey: ${errorMsg}`);
                        } else if (response.status === 500) {
                            throw new Error(`Server busy. Try again later: ${errorMsg}`);
                        } else {
                            throw new Error(`API error: ${response.status} ${errorMsg}`);
                        }
                    }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return JSON.parse(result.candidates[0].content.parts[0].text);
                    }
                    throw new Error('Unexpected API response structure.');
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        };

        // UI utility module
        const UIUtil = {
            showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                    section.classList.add('hidden');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    setTimeout(() => targetSection.classList.add('active'), 50);
                    targetSection.scrollIntoView({ behavior: 'smooth' });
                    targetSection.focus();
                }
            },

            showModal(message, type = 'success') {
                const modal = document.getElementById('modal');
                const modalMessage = document.getElementById('modalMessage');
                modalMessage.textContent = message;
                modal.classList.add('show', type);
                modal.focus();
                setTimeout(() => this.hideModal(), 3000);
            },

            hideModal() {
                const modal = document.getElementById('modal');
                modal.classList.remove('show', 'success', 'error');
            },

            setButtonLoading(button, isLoading) {
                button.innerHTML = isLoading 
                    ? '<span class="spinner"></span> လုပ်ဆောင်နေသည်...' 
                    : 'မေးခွန်းများဖြင့် ဂျာနယ်ရေးမည်';
                button.disabled = isLoading;
            },

            updateProgressBar(current, total) {
                const progressBar = document.getElementById('progressBar');
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
            },

            triggerPromptTransition() {
                const promptDisplay = document.getElementById('promptDisplay');
                promptDisplay.classList.add('prompt-transition');
                setTimeout(() => promptDisplay.classList.remove('prompt-transition'), 500);
            }
        };

        // Main Journal App Class
        class JournalApp {
            constructor() {
                this.currentPromptIndex = 0;
                this.promptAnswers = [];
                this.activePrompts = [];
                this.defaultPrompts = [
                    "ယနေ့အတွက် သင်ကျေးဇူးတင်ရမည့်အရာများကား အဘယ်နည်း။",
                    "ယနေ့ သင်ခံစားရသော စိတ်ခံစားမှုများနှင့် ၎င်းတို့၏ အကြောင်းအမျိုးမျိုးကား အဘယ်နည်း၊",
                    "ယနေ့ သင်အသစ်သိရှိခဲ့သည့်အရာတစ်ခုခု ရှိပါသလား။",
                    "မနက်ဖြန်အတွက် သင်မျှော်လင့်ထားသည့်အရာများကား အဘယ်နည်း။",
                    "ယနေ့ သင့်ကိုယ်သင် ပေးလိုက်မည့် သတင်းစကားတစ်ခုကား အဘယ်နည်း။"
                ];
                this.philosophyQuotes = [
                    {
                        text: "ဘဝသည် သင်ယူခြင်းနှင့် ကြီးထွားခြင်းအတွက် အခွင့်အလမ်းများပေးသည်။ သင့်အတွေးများကို ရေးသားခြင်းဖြင့် သင့်ကိုယ်ပိုင်ခရီးကို ပိုမိုနားလည်နိုင်ပါသည်။",
                        source: "သင့်နှလုံးသားထဲမှ"
                    },
                    {
                        text: "ဘဝတွင် အချိန်တိုင်းသည် အသစ်သောအစပြုမှုတစ်ခုဖြစ်သည်။ ယနေ့သင်လုပ်ဆောင်မည့် အပြုသဘောဆောင်သော ခြေလှမ်းတစ်ခုကို ရွေးချယ်ပါ။",
                        source: "အတွင်းစိတ်မှ ဉာဏ်အလင်း"
                    },
                    {
                        text: "သင့်အိပ်မက်များသည် သင့်ကို လမ်းပြပေးနိုင်သည်။ ၎င်းတို့ကို ရေးမှတ်ထားပြီး အကောင်အထည်ဖော်ရန် မကြောက်ပါနှင့်။",
                        source: "အိပ်မက်များမှ"
                    },
                    {
                        text: "ဘဝသည် စိတ်ကူးယဉ်မှုနှင့် လက်တွေ့ဘဝအကြား ချိန်ခွင်လျှာတစ်ခုဖြစ်သည်။ သင့်နှလုံးသားကို နားထောင်ပြီး ရှေ့ဆက်လှမ်းပါ။",
                        source: "ဘဝ၏ ချိန်ခွင်လျှာမှ"
                    },
                    {
                        text: "ယနေ့သင်လုပ်ဆောင်သော သေးငယ်သောခြေလှမ်းများသည် မနက်ဖြန်တွင် ကြီးမားသောပြောင်းလဲမှုများဆီသို့ ဦးတည်သည်။",
                        source: "အနာဂတ်မှ မျှော်လင့်ချက်"
                    }
                ];
                this.isLoading = false;
                this.promptCache = new Map();
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkInitialState();
                this.displayRandomPhilosophy();
            }

            bindEvents() {
                document.getElementById('saveApiKeyBtn').addEventListener('click', () => this.saveApiKey());
                document.getElementById('clearApiKeyBtn').addEventListener('click', () => this.clearApiKey());
                document.getElementById('agreePrivacyBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToPrivacy', true);
                    UIUtil.showSection('termsSection');
                });
                document.getElementById('agreeTermsBtn').addEventListener('click', () => {
                    StorageUtil.save('agreedToTerms', true);
                    UIUtil.showSection('guideSection');
                });
                document.getElementById('startJournalingBtn').addEventListener('click', () => this.promptForApiKeyOrStartJournaling());
                document.getElementById('startPromptsBtn').addEventListener('click', () => this.startPrompts());
                document.getElementById('backToJournalBtn').addEventListener('click', () => this.showJournalSection());
                document.getElementById('backToMainJournalBtn').addEventListener('click', () => this.showJournalSection());
                document.getElementById('prevPromptBtn').addEventListener('click', () => this.previousPrompt());
                document.getElementById('nextPromptBtn').addEventListener('click', () => this.nextPrompt());
                document.getElementById('combineAnswersBtn').addEventListener('click', () => this.combineAnswers());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyJournalText());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportToNotion());
                document.getElementById('modalClose').addEventListener('click', () => UIUtil.hideModal());
                document.getElementById('modal').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('modal')) UIUtil.hideModal();
                });
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
            }

            displayRandomPhilosophy() {
                const randomIndex = Math.floor(Math.random() * this.philosophyQuotes.length);
                const quote = this.philosophyQuotes[randomIndex];
                document.getElementById('philosophyText').textContent = quote.text;
                document.getElementById('sourceCredit').textContent = `ရင်းမြစ်: ${quote.source}`;
            }

            checkInitialState() {
                const agreedToPrivacy = StorageUtil.load('agreedToPrivacy');
                const agreedToTerms = StorageUtil.load('agreedToTerms');
                const agreedToGuide = StorageUtil.load('agreedToGuide');
                const hasApiKey = StorageUtil.load('geminiApiKey');

                if (!agreedToPrivacy) {
                    UIUtil.showSection('privacySection');
                } else if (!agreedToTerms) {
                    UIUtil.showSection('termsSection');
                } else if (!agreedToGuide) {
                    UIUtil.showSection('guideSection');
                } else if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            showJournalSection() {
                UIUtil.showSection('journalSection');
                this.setTodayDate();
                document.getElementById('journalMood').value = '';
                this.displayRandomPhilosophy();
            }

            setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('journalDate').value = today;
            }

            saveApiKey() {
                const apiKeyInput = document.getElementById('apiKeyInput');
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    UIUtil.showModal('API Key ထည့်ပေးပါ။', 'error');
                    return;
                }
                if (StorageUtil.save('geminiApiKey', apiKey)) {
                    UIUtil.showModal('API Key ကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။', 'success');
                    this.showJournalSection();
                } else {
                    UIUtil.showModal('API Key သိမ်းဆည်းမှု မအောင်မြင်ပါ။', 'error');
                }
            }

            clearApiKey() {
                if (StorageUtil.remove('geminiApiKey')) {
                    document.getElementById('apiKeyInput').value = '';
                    UIUtil.showModal('API Key ကို ဖယ်ရှားပြီးပါပြီ။', 'success');
                    UIUtil.showSection('apiKeySection');
                } else {
                    UIUtil.showModal('API Key ဖယ်ရှားမှု မအောင်မြင်ပါ။', 'error');
                }
            }

            promptForApiKeyOrStartJournaling() {
                StorageUtil.save('agreedToGuide', true);
                const hasApiKey = StorageUtil.load('geminiApiKey');
                if (!hasApiKey) {
                    UIUtil.showSection('apiKeySection');
                } else {
                    this.showJournalSection();
                }
            }

            async startPrompts() {
                if (this.isLoading) return;
                this.isLoading = true;

                const mood = document.getElementById('journalMood').value;
                const date = document.getElementById('journalDate').value;
                const startBtn = document.getElementById('startPromptsBtn');

                if (!mood || !date) {
                    UIUtil.showModal('စိတ်ခံစားမှုနှင့် ရက်စွဲကို ရွေးချယ်ပေးပါ။', 'error');
                    this.isLoading = false;
                    return;
                }

                UIUtil.setButtonLoading(startBtn, true);

                try {
                    const apiKey = StorageUtil.load('geminiApiKey');
                    const cacheKey = `prompts_${mood}_${date}`;
                    let prompts;

                    if (this.promptCache.has(cacheKey)) {
                        prompts = this.promptCache.get(cacheKey);
                    } else {
                        prompts = await GeminiAPI.fetchPrompts(mood, apiKey);
                        if (!Array.isArray(prompts) || prompts.length < 5) {
                            throw new Error('Invalid prompts format from API.');
                        }
                        this.promptCache.set(cacheKey, prompts);
                    }

                    this.activePrompts = prompts;
                    this.promptAnswers = new Array(prompts.length).fill('');
                    this.currentPromptIndex = 0;

                    UIUtil.showSection('promptsSection');
                    this.displayPrompt();
                } catch (error) {
                    UIUtil.showModal(`မေးခွန်းများ ရယူမှု မအောင်မြင်ပါ: ${error.message}`, 'error');
                    this.activePrompts = this.defaultPrompts;
                    this.promptAnswers = new Array(this.defaultPrompts.length).fill('');
                    this.currentPromptIndex = 0;
                    UIUtil.showSection('promptsSection');
                    this.displayPrompt();
                } finally {
                    UIUtil.setButtonLoading(startBtn, false);
                    this.isLoading = false;
                }
            }

            displayPrompt() {
                const promptText = document.getElementById('currentPromptText');
                const promptAnswer = document.getElementById('promptAnswerTextarea');
                const prevBtn = document.getElementById('prevPromptBtn');
                const nextBtn = document.getElementById('nextPromptBtn');
                const combineBtn = document.getElementById('combineAnswersBtn');
                const counter = document.getElementById('promptCounter');

                promptText.textContent = this.activePrompts[this.currentPromptIndex];
                promptAnswer.value = this.promptAnswers[this.currentPromptIndex] || '';
                counter.textContent = `${this.currentPromptIndex + 1}/${this.activePrompts.length}`;

                prevBtn.disabled = this.currentPromptIndex === 0;
                nextBtn.textContent = 'နောက်မေးခွန်း';
                combineBtn.classList.toggle('hidden', this.currentPromptIndex !== this.activePrompts.length - 1);

                UIUtil.updateProgressBar(this.currentPromptIndex + 1, this.activePrompts.length);
                UIUtil.triggerPromptTransition();
                promptAnswer.focus();
            }

            previousPrompt() {
                if (this.currentPromptIndex > 0) {
                    this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value;
                    this.currentPromptIndex--;
                    this.displayPrompt();
                }
            }

            nextPrompt() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value;
                if (this.currentPromptIndex < this.activePrompts.length - 1) {
                    this.currentPromptIndex++;
                    this.displayPrompt();
                } else {
                    this.combineAnswers();
                }
            }

            async combineAnswers() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value;
                const journalText = this.promptAnswers
                    .map((answer, i) => `**မေးခွန်း ${i + 1}: ${this.activePrompts[i]}**\n${answer}`)
                    .join('\n\n');

                if (!this.promptAnswers.some(answer => answer.trim())) {
                    UIUtil.showModal('အနည်းဆုံး အဖြေတစ်ခုခု ပေးပါ။', 'error');
                    return;
                }

                this.isLoading = true;
                try {
                    const apiKey = StorageUtil.load('geminiApiKey');
                    const mood = document.getElementById('journalMood').value;
                    const analysis = await GeminiAPI.fetchAnalysis(journalText, mood, apiKey);

                    this.displayAnalysisResults(analysis, journalText);
                    UIUtil.showSection('analysisSection');
                } catch (error) {
                    UIUtil.showModal(`သုံးသပ်ချက် ရယူမှု မအောင်မြင်ပါ: ${error.message}`, 'error');
                } finally {
                    this.isLoading = false;
                }
            }

            displayAnalysisResults(analysis, journalText) {
                const { summary, themes, actions, affirmation } = analysis;

                document.getElementById('analysisSummary').textContent = summary || 'အနှစ်ချုပ် မရှိပါ။';
                const themesList = document.getElementById('keyThemesList');
                themesList.innerHTML = themes?.map(theme => `<li>${theme}</li>`).join('') || '<li>အဓိကအကြောင်းအရာများ မတွေ့ပါ။</li>';
                const actionList = document.getElementById('actionItemsList');
                actionList.innerHTML = actions?.map(item => `<li>${item}</li>`).join('') || '<li>လုပ်ဆောင်ရမည့်အချက်များ မရှိပါ။</li>';
                document.getElementById('affirmationDisplay').textContent = affirmation || 'ဆက်လက်တောက်ပပါ။';
                document.getElementById('combinedJournalText').value = journalText;
            }

            copyJournalText() {
                const journalText = document.getElementById('combinedJournalText').value;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(journalText)
                        .then(() => UIUtil.showModal('ဂျာနယ်စာသားကို ကူးယူပြီးပါပြီ။', 'success'))
                        .catch((err) => {
                            console.error('Clipboard API failed:', err);
                            this.fallbackCopyText(journalText);
                        });
                } else {
                    this.fallbackCopyText(journalText);
                }
            }

            fallbackCopyText(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        UIUtil.showModal('ဂျာနယ်စာသားကို ကူးယူပြီးပါပြီ။', 'success');
                    } else {
                        UIUtil.showModal('စာသားကူးယူမှု မအောင်မြင်ပါ။ ကျေးဇူးပြု၍ စာသားကို ကိုယ်တိုင်ရွေးပြီး ကူးယူပါ။', 'error');
                    }
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    UIUtil.showModal('စာသားကူးယူမှု မအောင်မြင်ပါ။ ကျေးဇူးပြု၍ စာသားကို ကိုယ်တိုင်ရွေးပြီး ကူးယူပါ။', 'error');
                } finally {
                    document.body.removeChild(textArea);
                }
            }

            exportToNotion() {
                const journalText = document.getElementById('combinedJournalText').value;
                const date = document.getElementById('journalDate').value;
                const mood = document.getElementById('journalMood').value;
                const markdown = `# ဂျာနယ်မှတ်တမ်း - ${date} (${mood})\n\n${journalText.replace(/\*\*/g, '###')}`;
                
                const blob = new Blob([markdown], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `journal_${date}.md`;
                a.click();
                URL.revokeObjectURL(url);
                UIUtil.showModal('ဂျာနယ်ကို Markdown အဖြစ် ထုတ်ယူပြီးပါပြီ။', 'success');
            }

            handleKeydown(event) {
                if (event.key === 'Enter' && !event.shiftKey && document.activeElement === document.getElementById('promptAnswerTextarea')) {
                    event.preventDefault();
                    this.nextPrompt();
                }
                if (event.key === 'Escape') {
                    UIUtil.hideModal();
                }
            }
        }

        // Initialize the app
        const app = new JournalApp();
    </script>
</body>
</html>
