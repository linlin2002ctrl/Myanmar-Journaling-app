<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ဖွင့်ဟ (Pwin Ha) - Journaling App</title>

    <!-- ======== App Icon Links ======== -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- ======== Stylesheets ======== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-accent: #E91E63; --secondary-accent: #10B981; --background-main: #FDF8F5;
            --card-bg: #FFFFFF; --text-dark: #212529; --text-light: #6c757d;
            --border-color: #EAEAEA; --prompt-bg: #FFFFFF;
            --shadow-sm: 0 2px 4px rgb(0 0 0 / 5%); --shadow-md: 0 4px 8px rgb(0 0 0 / 7%); --shadow-lg: 0 10px 20px rgb(0 0 0 / 10%);
        }
        body { font-family: 'Pyidaungsu', sans-serif; background-color: var(--background-main); color: var(--text-dark); padding: 1rem 0; }
        .main-container { max-width: 500px; margin: 0 auto; }
        .card {
            background-color: var(--card-bg); border: none; border-radius: 1.5rem; box-shadow: var(--shadow-lg);
            padding: 1.5rem; animation: cardFadeIn 0.6s ease-out forwards; opacity: 0; transform: translateY(20px);
        }
        @keyframes cardFadeIn { to { opacity: 1; transform: translateY(0); } }
        .btn {
            font-weight: 700; border-radius: 50rem; padding: 0.75rem 1.5rem;
            transition: all 0.25s ease-in-out; box-shadow: var(--shadow-sm); border: none;
        }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .btn-primary { background-color: var(--primary-accent); color: white; }
        .btn-primary:hover { background-color: #C2185B; }
        .btn-secondary { background-color: var(--secondary-accent); color: white; }
        .btn-secondary:hover { background-color: #059669; }
        .btn-outline-primary { border: 2px solid #D1D5DB; color: var(--text-dark); background-color: transparent; }
        .btn-outline-primary:hover { border-color: var(--primary-accent); color: var(--primary-accent); }
        .form-control, .form-select { border-radius: 0.75rem; padding: 0.75rem 1rem; border: 1px solid var(--border-color); background-color: #F9FAFB; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 0.2rem rgb(233 30 99 / 25%); background-color: white; }
        .header-title { display: flex; align-items: center; justify-content: center; gap: 0.75rem; font-size: 2rem; font-weight: 700; color: var(--text-dark); }
        .hidden { display: none !important; }
        .loading-spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        .mood-selector { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
        .mood-option { padding: 0.5rem 1rem; border: 2px solid var(--border-color); border-radius: 50rem; cursor: pointer; transition: all 0.2s ease-in-out; background-color: var(--card-bg); }
        .mood-option:hover { transform: scale(1.05); border-color: var(--primary-accent); }
        .mood-option.active { background-color: var(--primary-accent); color: white; border-color: var(--primary-accent); font-weight: bold; }
        #prompt-title { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .progress-bar { background-color: var(--primary-accent); transition: width 0.4s ease-in-out; }
        .prompt-box { background-color: var(--prompt-bg); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.25rem; }
        #currentPromptText { font-size: 1.15rem; font-weight: 600; line-height: 1.6; margin-bottom: 1rem; color: var(--text-dark); }
        #promptAnswerTextarea { min-height: 120px; }
        .analysis-section { background-color: #f0fff4; border: 1px solid #a7e0b4; color: var(--text-dark); }
        .history-item:hover { background-color: #f1f5f9; cursor: pointer; }
        .settings-btn { display: flex; align-items: center; justify-content: center; width: 45px; height: 45px; padding: 0; border-radius: 50%; }
        .history-category-title { font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center">
    
    <div class="container main-container">
        <div class="card">
            <main id="app-content" role="main"></main>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>
    </div>
    
    <!-- Modals -->
    <div class="modal fade" id="entryDetailModal" tabindex="-1" aria-labelledby="entryDetailTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="entryDetailTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body" id="entryDetailBody"></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="vpnWarningModal" tabindex="-1" aria-labelledby="vpnWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1.5rem;">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title w-100 text-center fw-bold" id="vpnWarningModalLabel">
                        <i data-feather="shield" class="text-primary me-2"></i>မေတ္တာဖြင့် အကြံပြုချက်
                    </h5>
                </div>
                <div class="modal-body text-center px-4">
                    <p class="mb-0" style="line-height: 1.8;">
                        ညီမလေး/မောင်လေးတို့ရဲ့ လုံခြုံရေးအတွက်၊ ဒီအက်ပ်လေးကို အသုံးပြုတဲ့အခါ VPN လေးတစ်ခု ချိတ်ဆက်ထားပေးဖို့ အကြံပြုပါရစေရှင်။<br><br>ဒါမှ AI ဝန်ဆောင်မှုတွေကို အပြည့်အဝနဲ့ အဆင်ပြေချောမွေ့စွာ အသုံးပြုနိုင်မှာပါရှင့်။
                    </p>
                </div>
                <div class="modal-footer border-top-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">နားလည်ပါပြီရှင်</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Main Application Script -->
    <script>
        // --- TEMPLATES FOR DYNAMIC UI ---
        const templates = {
            header: `
                <header class="d-flex justify-content-between align-items-center mb-4">
                    <div class="header-title flex-grow-1">
                        <img src="/favicon-32x32.png" alt="App Icon" style="width: 32px; height: 32px;">
                        <span>ဖွင့်ဟ</span>
                    </div>
                    <button id="settingsBtn" class="btn btn-light settings-btn" title="ဆက်တင်များ" aria-label="ဆက်တင်များ ဖွင့်မည်">
                        <i data-feather="settings"></i>
                    </button>
                </header>`,
            journalSection: `
                <div class="mb-4">
                    <label for="journalDate" class="form-label fw-bold">ရက်စွဲ:</label>
                    <input type="date" id="journalDate" class="form-control" required>
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold mb-3">လက်ရှိစိတ်ခံစားမှု:</label>
                    <div id="journalMood" class="mood-selector">
                       <div class="mood-option" data-value="ပျော်ရွှင်">😊 ပျော်ရွှင်</div> <div class="mood-option" data-value="ဝမ်းနည်း">😢 ဝမ်းနည်း</div>
                       <div class="mood-option" data-value="စိတ်တို">😠 စိတ်တို</div> <div class="mood-option" data-value="စိတ်လှုပ်ရှား">🤩 စိတ်လှုပ်ရှား</div>
                       <div class="mood-option" data-value="ငြိမ်သက်">😌 ငြိမ်သက်</div> <div class="mood-option" data-value="ပင်ပန်း">😴 ပင်ပန်း</div>
                       <div class="mood-option" data-value="စိတ်ရှုပ်">😕 စိတ်ရှုပ်</div> <div class="mood-option" data-value="ကျေနပ်">👍 ကျေနပ်</div>
                    </div>
                    <input type="hidden" id="selectedMood" value="">
                </div>
                <div class="mt-4 text-center d-grid gap-3">
                    <h3 class="h5 mb-2 fw-bold">ဘယ်လို မှတ်တမ်းမျိုးရေးမလဲ။</h3>
                    <button id="startMorningBtn" class="btn btn-primary">🌅 မနက်ခင်း မှတ်တမ်း</button>
                    <button id="startNightBtn" class="btn btn-primary">🌃 ညပိုင်း မှတ်တမ်း</button>
                    <button id="startGratitudeBtn" class="btn btn-secondary">🙏 ကျေးဇူးတင်ခြင်း</button>
                    <button id="startGeneralBtn" class="btn btn-light border">💬 အထွေထွေ ရင်ဖွင့်ခြင်း</button>
                    <hr>
                    <button id="myJournalBtn" class="btn btn-outline-primary">📖 ကျွန်ုပ်၏ မှတ်တမ်းများ</button>
                </div>
            `,
            settingsSection: `
                <h2 class="h3 fw-bold text-center mb-4">ဆက်တင်များ</h2>
                <div class="mb-3">
                    <label for="userNameInput" class="form-label">သင့်အမည် (သို့မဟုတ်) နာမည်ပြောင်:</label>
                    <input type="text" id="userNameInput" class="form-control" placeholder="ဥပမာ - အောင်အောင်">
                </div>
                <div class="mb-3">
                    <label class="form-label">ကျား/မ:</label>
                    <div class="d-flex justify-content-center gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="genderOptions" id="genderMale" value="male">
                            <label class="form-check-label" for="genderMale">ကျား</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="genderOptions" id="genderFemale" value="female">
                            <label class="form-check-label" for="genderFemale">မ</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="genderOptions" id="genderUnspecified" value="unspecified">
                            <label class="form-check-label" for="genderUnspecified">မသတ်မှတ်လိုပါ</label>
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="apiKeyInput" class="form-label">Gemini API Key: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="small text-decoration-none">(API Key အခမဲ့ရယူရန်)</a></label>
                    <input type="password" id="apiKeyInput" class="form-control" placeholder="သင်၏ API Key ကိုထည့်ပါ">
                </div>
                <div class="d-grid gap-2">
                    <button id="saveSettingsBtn" class="btn btn-primary">သိမ်းမည်</button>
                    <button id="backToMainFromSettingsBtn" class="btn btn-outline-primary">ပင်မစာမျက်နှာသို့</button>
                </div>
            `,
            promptsSection: `
                <h2 id="prompt-title" class="h4 fw-bold text-center mb-3"></h2>
                <div class="progress mb-4" role="progressbar" aria-label="မေးခွန်းတိုးတက်မှု" style="height: 8px;">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <div class="prompt-box mb-4">
                    <p id="currentPromptText" class="text-center"></p>
                    <textarea id="promptAnswerTextarea" class="form-control" placeholder="သင့်အဖြေကို ဤနေရာတွင် ရေးသားနိုင်ပါသည်..."></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <button id="prevPromptBtn" class="btn btn-outline-primary" disabled>ယခင်မေးခွန်း</button>
                    <span id="promptCounter" class="text-muted fw-bold"></span>
                    <button id="nextPromptBtn" class="btn btn-primary">နောက်မေးခွန်း</button>
                    <button id="combineAnswersBtn" class="btn btn-primary hidden">ပြီးပြီ</button>
                </div>
                <div class="text-center mt-4">
                    <button id="backToMainFromPromptsBtn" class="btn btn-sm btn-light">ပင်မစာမျက်နှာသို့</button>
                </div>
            `,
            analysisSection: `
                <h2 class="h3 fw-bold text-center mb-4">AI ၏ သုံးသပ်အကြံပြုချက်</h2>
                <div id="analysis-content-wrapper">
                    <div class="analysis-section p-3 rounded mb-4">
                        <h3 class="h5 mb-2 fw-bold" style="color: #059669;">AI အကြံပြုချက်</h3>
                        <p id="aiSuggestionDisplay" class="text-dark whitespace-pre-wrap"></p>
                    </div>
                </div>
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h3 class="h5 mb-2 fw-bold">သင်၏ အတွေးအမြင်များ</h3>
                        <textarea id="combinedJournalText" class="form-control" rows="10" readonly></textarea>
                    </div>
                </div>
                <div id="analysis-actions" class="d-grid gap-2"></div>
            `,
            journalHistorySection: `
                <h2 class="h3 fw-bold text-center mb-4">ကျွန်ုပ်၏ မှတ်တမ်းများ</h2>
                
                <!-- START: Filter UI Changes -->
                <div class="row g-3 mb-4">
                    <div class="col-12 col-md-6">
                        <label for="typeFilter" class="form-label">အမျိုးအစားအလိုက် စစ်ထုတ်ရန်:</label>
                        <select class="form-select" id="typeFilter">
                            <option value="all" selected>အမျိုးအစားအားလုံး</option>
                            <option value="morning">🌅 မနက်ခင်း</option>
                            <option value="night">🌃 ညပိုင်း</option>
                            <option value="gratitude">🙏 ကျေးဇူးတင်ခြင်း</option>
                            <option value="general">💬 အထွေထွေ</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <label for="moodFilter" class="form-label">စိတ်ခံစားမှုအလိုက် စစ်ထုတ်ရန်:</label>
                        <select class="form-select" id="moodFilter">
                            <option value="all" selected>စိတ်ခံစားမှုအားလုံး</option>
                            <option value="ပျော်ရွှင်">😊 ပျော်ရွှင်</option>
                            <option value="ဝမ်းနည်း">😢 ဝမ်းနည်း</option>
                            <option value="စိတ်တို">😠 စိတ်တို</option>
                            <option value="စိတ်လှုပ်ရှား">🤩 စိတ်လှုပ်ရှား</option>
                            <option value="ငြိမ်သက်">😌 ငြိမ်သက်</option>
                            <option value="ပင်ပန်း">😴 ပင်ပန်း</option>
                            <option value="စိတ်ရှုပ်">😕 စိတ်ရှုပ်</option>
                            <option value="ကျေနပ်">👍 ကျေနပ်</option>
                        </select>
                    </div>
                </div>
                <!-- END: Filter UI Changes -->

                <div id="history-container" class="list-group"></div>
                <p id="noHistoryMessage" class="text-center text-muted hidden mt-4">မှတ်တမ်းများ မရှိသေးပါ။</p>
                <p id="noFilterResultMessage" class="text-center text-muted hidden mt-4">ရွေးချယ်ထားသော စစ်ထုတ်မှုနှင့် ကိုက်ညီသည့် မှတ်တမ်းများ မရှိပါ။</p>
                
                <!-- START: Button UI Changes -->
                <div class="mt-4 text-center">
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-3">
                        <button id="summarizeAllBtn" class="btn btn-primary btn-sm">✨ အနှစ်ချုပ်မည်</button>
                        <button id="analyzeMoodBtn" class="btn btn-secondary btn-sm">📊 စိတ်ခံစားမှု ခွဲခြမ်းစိတ်ဖြာမည်</button>
                    </div>
                    <div class="d-grid">
                        <button id="backToMainFromHistoryBtn" class="btn btn-outline-primary">ပင်မစာမျက်နှာသို့</button>
                    </div>
                </div>
                <!-- END: Button UI Changes -->
            `,
            summarySection: `
                <h2 class="h3 fw-bold text-center mb-4">AI ၏ မှတ်တမ်းများ အနှစ်ချုပ်</h2>
                <div class="analysis-section p-3 rounded mb-4">
                    <h3 class="h5 mb-2 fw-bold" style="color: #059669;">AI အနှစ်ချုပ်</h3>
                    <p id="aiSummaryDisplay" class="text-dark whitespace-pre-wrap"></p>
                </div>
                <div class="text-center mt-3 d-grid">
                    <button id="backFromSummaryBtn" class="btn btn-outline-primary">နောက်သို့</button>
                </div>
            `,
            moodAnalysisSection: `
                <h2 class="h3 fw-bold text-center mb-4">AI ၏ စိတ်ခံစားမှု ခွဲခြမ်းစိတ်ဖြာချက်</h2>
                <div class="analysis-section p-3 rounded mb-4">
                    <h3 class="h5 mb-2 fw-bold" style="color: #059669;">AI ခွဲခြမ်းစိတ်ဖြာချက်</h3>
                    <p id="aiMoodAnalysisDisplay" class="text-dark whitespace-pre-wrap"></p>
                </div>
                <div class="text-center mt-3 d-grid">
                    <button id="backFromMoodAnalysisBtn" class="btn btn-outline-primary">နောက်သို့</button>
                </div>
            `
        };

        // --- UTILITIES AND SERVICES ---
        const StorageUtil = {
            save: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.error("LS Error:", e); } },
            load: (key) => { try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : null; } catch (e) { console.error("LS Error:", e); return null; } }
        };

        const UIUtil = {
            render: (targetElement, template) => { targetElement.innerHTML = template; },
            showToast: (msg, type = 'dark') => {
                const container = document.querySelector('.toast-container');
                if (!container) return;
                const el = document.createElement('div');
                el.className = `toast align-items-center text-bg-${type} border-0`;
                el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
                container.appendChild(el);
                new bootstrap.Toast(el, { delay: 5000 }).show();
            },
            setLoading: (el, loading, text) => {
                if (!el) return;
                const originalText = el.dataset.originalText || text;
                el.dataset.originalText = originalText;
                el.disabled = loading;
                el.innerHTML = loading ? `<span class="loading-spinner"></span>${text}` : originalText;
            }
        };
        
        const GeminiAPI = {
            async generateText(prompt, apiKey) {
                const model = "gemini-1.5-flash";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
                const requestBody = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "text/plain" },
                    safetySettings: [
                        { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' }, { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                        { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' }, { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                    ]
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        if (err?.error?.message?.includes("API key not valid")) { throw new Error("သင်၏ API Key မမှန်ကန်ပါ။ ဆက်တင်များတွင် ပြန်လည်စစ်ဆေးပါ။"); }
                        throw new Error("AI နှင့် ချိတ်ဆက်ရာတွင် အဆင်မပြေဖြစ်သွားလို့ပါရှင်။");
                    }
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) { console.error("API Call Failed:", error); throw error; }
            },

            async fetchCounselorAdvice(journalText, mood, mode, apiKey, gender = 'unspecified') {
                let genderInstruction = "သင့်အနေနဲ့ ကျား/မ လိင်ကွဲပြားမှုမရှိတဲ့ ယေဘုယျလေသံ (gender-neutral tone) ကိုသာ အသုံးပြုပြီး ရေးသားပေးပါ။";
                if (gender === 'male') {
                    genderInstruction = "အရေးကြီး: သင်၏တုံ့ပြန်မှုသည် အသုံးပြုသူကို 'မောင်လေး' သို့မဟုတ် 'သား' ဟု နွေးထွေးစွာခေါ်ပြီး 'ခင်ဗျာ' ဆိုသည့်နောက်ဆက်တွဲဖြင့် ယဉ်ကျေးစွာရေးသားရမည်။";
                } else if (gender === 'female') {
                    genderInstruction = "အရေးကြီး: သင်၏တုံ့ပြန်မှုသည် အသုံးပြုသူကို 'ညီမလေး' သို့မဟုတ် 'သမီး' ဟု နွေးထွေးစွာခေါ်ပြီး 'ရှင့်' ဆိုသည့်နောက်ဆက်တွဲဖြင့် ယဉ်ကျေးစွာရေးသားရမည်။";
                }

                const prompt = `You are a warm, wise, and deeply compassionate Burmese mind therapist. ${genderInstruction} A user has just completed a '${mode}' reflection. Their stated mood is '${mood}'. Their journal entry is below.\n\n---\n${journalText}\n---\n\nYour task is to respond in flawless, natural, and flowing Burmese that feels like a heartfelt message from a caring, wise friend, not an AI. Strictly avoid robotic phrasing and clinical jargon. Follow these steps precisely:\n1. Acknowledge their feelings with genuine, deep empathy.\n2. Offer a fresh, gentle perspective on their thoughts.\n3. Provide one or two simple, truly actionable suggestions.\n4. End with a sincerely warm and encouraging closing statement.\nYour entire response must be a single, coherent block of text in perfect Burmese.`;
                return this.generateText(prompt, apiKey);
            }
        };

        // --- MAIN APPLICATION LOGIC ---
        class JournalApp {
            constructor() {
                this.mainContent = document.getElementById('app-content');
                this.journalEntries = StorageUtil.load('journalEntries') || [];
                this.userName = StorageUtil.load('userName') || '';
                this.apiKey = StorageUtil.load('geminiApiKey') || '';
                this.gender = StorageUtil.load('userGender') || 'unspecified';
                this.defaultPrompts = {
                    morning: ["ဒီမနက်ခင်းမှာ ဘယ်အရာက သင့်ကို အားအပြည့်ဆုံးဖြစ်စေသလဲ။", "ဒီနေ့ကို အကောင်းဆုံးနေ့တစ်နေ့ ဖြစ်စေဖို့ ဘယ်လိုရည်ရွယ်ချက်မျိုး ထားရှိထားပါသလဲ။", "သင့်ကိုယ်သင် ပျော်ရွှင်အောင် ဒီနေ့ ဘာလုပ်ပေးဖို့ စဉ်းစားထားပါသလဲ။"],
                    night: ["ဒီနေ့ သင်ယူလိုက်ရတဲ့ အရေးကြီးဆုံးအရာက ဘာဖြစ်မလဲ။", "ဘယ်အဖြစ်အပျက်က သင့်ကို ပြုံးပျော်စေခဲ့ပါသလဲ။", "ဒီနေ့အတွက် စိတ်ထဲကနေ ထုတ်ချပစ်ချင်တဲ့ အရာတစ်ခုခု ရှိပါသလား။"],
                    gratitude: ["ယနေ့ သင်ကျေးဇူးတင်မိတဲ့ လူပုဂ္ဂိုလ်တစ်ဦးက ဘယ်သူလဲ၊ ဘာကြောင့်လဲ။", "သင့်ဘဝမှာ လက်ရှိပိုင်ဆိုင်ထားတဲ့အရာတွေထဲက ဘာတွေအတွက် ကျေးဇူးတင်မိပါသလဲ။", "ယနေ့ သင့်ကို ပျော်ရွှင်စေခဲ့တဲ့ သေးငယ်တဲ့အရာတစ်ခုကို ဖော်ပြပါ။"],
                    general: ["အခုအချိန်မှာ သင့်စိတ်ထဲမှာ ဘယ်လိုခံစားနေရပါသလဲ။", "အဲ့ဒီခံစားချက်ကို ဖြစ်စေတဲ့ အကြောင်းရင်းက ဘာဖြစ်နိုင်မလဲ။", "သင့်အတွက် ဘာလုပ်ပေးရင် စိတ်သက်သာရာရနိုင်မလဲဆိုတာ ပြောပြပေးပါ။"]
                };
                this.resetPromptState();
                this.init();
            }

            init() {
                this.showVpnWarningOnce();
                if (!this.apiKey) { this.showSettings(); } 
                else { this.showJournalSection(); }
            }

            showVpnWarningOnce() {
                if (!StorageUtil.load('vpnWarningShown')) {
                    const vpnModalEl = document.getElementById('vpnWarningModal');
                    if (vpnModalEl) {
                        const vpnModal = new bootstrap.Modal(vpnModalEl);
                        vpnModal.show();
                        StorageUtil.save('vpnWarningShown', true);
                    }
                }
            }
            
            resetPromptState() { this.currentPromptIndex = 0; this.promptAnswers = []; this.activePrompts = []; }

            renderView(viewTemplate, bindEventsCallback) {
                this.mainContent.innerHTML = templates.header + viewTemplate;
                feather.replace(); 
                if (bindEventsCallback) bindEventsCallback.call(this);
            }

            // --- View Rendering and Binding ---
            showJournalSection() { this.renderView(templates.journalSection, this.bindMainButtons); }
            showSettings() { this.renderView(templates.settingsSection, this.bindSettingsButtons); }
            showHistory() { this.renderView(templates.journalHistorySection, this.bindHistoryPageEvents); }
            showSummary(filteredEntries) { this.renderView(templates.summarySection, () => this.bindSummaryButtons(filteredEntries)); }
            showMoodAnalysis(filteredEntries) { this.renderView(templates.moodAnalysisSection, () => this.bindMoodAnalysisButtons(filteredEntries)); }

            bindMainButtons() {
                document.getElementById('journalDate').valueAsDate = new Date();
                document.getElementById('settingsBtn').onclick = () => this.showSettings();
                document.getElementById('myJournalBtn').onclick = () => this.showHistory();

                ['startMorningBtn:morning', 'startNightBtn:night', 'startGratitudeBtn:gratitude', 'startGeneralBtn:general'].forEach(pair => {
                    const [btnId, mode] = pair.split(':');
                    document.getElementById(btnId).onclick = () => this.startJournalingSession(mode);
                });
                
                document.querySelectorAll('.mood-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelector('.mood-option.active')?.classList.remove('active');
                        option.classList.add('active');
                        document.getElementById('selectedMood').value = option.dataset.value;
                    });
                });
            }
            
            bindSettingsButtons() {
                document.getElementById('userNameInput').value = this.userName;
                document.getElementById('apiKeyInput').value = this.apiKey;
                const genderRadio = document.querySelector(`input[name="genderOptions"][value="${this.gender}"]`);
                if (genderRadio) genderRadio.checked = true;
                
                document.getElementById('saveSettingsBtn').onclick = () => this.saveSettings();
                document.getElementById('backToMainFromSettingsBtn').onclick = () => this.showJournalSection();
            }
            
            // START: Updated History Page Logic
            bindHistoryPageEvents() {
                const moodFilter = document.getElementById('moodFilter');
                const typeFilter = document.getElementById('typeFilter');
                
                const renderFilteredHistory = () => {
                    const selectedMood = moodFilter.value;
                    const selectedType = typeFilter.value;
                    
                    const filteredEntries = this.journalEntries.filter(entry => {
                        const moodMatch = (selectedMood === 'all' || entry.mood === selectedMood);
                        const typeMatch = (selectedType === 'all' || entry.mode === selectedType);
                        return moodMatch && typeMatch;
                    });
                    
                    this.renderHistoryList(filteredEntries);
                    
                    // Update button listeners to pass the filtered list
                    document.getElementById('summarizeAllBtn').onclick = () => this.summarizeJournals(filteredEntries);
                    document.getElementById('analyzeMoodBtn').onclick = () => this.analyzeMoodTrends(filteredEntries);
                };
                
                moodFilter.onchange = renderFilteredHistory;
                typeFilter.onchange = renderFilteredHistory;
                document.getElementById('backToMainFromHistoryBtn').onclick = () => this.showJournalSection();
                
                // Initial render
                renderFilteredHistory();
            }

            renderHistoryList(entries) {
                const container = document.getElementById('history-container');
                const noHistoryMsg = document.getElementById('noHistoryMessage');
                const noFilterResultMsg = document.getElementById('noFilterResultMessage');
                
                container.innerHTML = '';
                noHistoryMsg.classList.add('hidden');
                noFilterResultMsg.classList.add('hidden');

                if (this.journalEntries.length === 0) {
                    noHistoryMsg.classList.remove('hidden');
                    return;
                }

                if (entries.length === 0) {
                    noFilterResultMsg.classList.remove('hidden');
                    return;
                }

                entries.sort((a,b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)).forEach(entry => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action history-item';
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${JournalApp.getPromptTitle(entry.mode)}</h5>
                            <small>${new Date(entry.date).toLocaleDateString('en-CA')}</small>
                        </div>
                        <p class="mb-1">စိတ်ခံစားမှု: ${entry.mood}</p>
                        <small class="text-muted">${entry.text.substring(0, 80)}...</small>
                    `;
                    item.onclick = (e) => { e.preventDefault(); this.showJournalEntryDetail(entry); };
                    container.appendChild(item);
                });
            }
            // END: Updated History Page Logic

            bindPromptButtons() {
                document.getElementById('prompt-title').innerHTML = JournalApp.getPromptTitle(this.journalMode);
                document.getElementById('prevPromptBtn').onclick = () => this.navigatePrompt(-1);
                document.getElementById('nextPromptBtn').onclick = () => this.navigatePrompt(1);
                document.getElementById('combineAnswersBtn').onclick = () => this.combineAnswers();
                document.getElementById('backToMainFromPromptsBtn').onclick = () => this.showJournalSection();
                this.displayCurrentPrompt();
            }

            bindSummaryButtons(filteredEntries) {
                document.getElementById('backFromSummaryBtn').onclick = () => this.showHistory();
            }

            bindMoodAnalysisButtons(filteredEntries) {
                document.getElementById('backFromMoodAnalysisBtn').onclick = () => this.showHistory();
            }

            saveSettings() {
                this.userName = document.getElementById('userNameInput').value.trim();
                this.apiKey = document.getElementById('apiKeyInput').value.trim();
                const selectedGender = document.querySelector('input[name="genderOptions"]:checked');
                this.gender = selectedGender ? selectedGender.value : 'unspecified';

                if (!this.apiKey) {
                    UIUtil.showToast('API Key ဖြည့်စွက်ရန် လိုအပ်ပါသည်။', 'danger');
                    return;
                }
                StorageUtil.save('userName', this.userName); 
                StorageUtil.save('geminiApiKey', this.apiKey);
                StorageUtil.save('userGender', this.gender);
                UIUtil.showToast('ဆက်တင်များကို သိမ်းဆည်းပြီးပါပြီ။', 'success');
                this.showJournalSection();
            }

            startJournalingSession(mode) {
                const mood = document.getElementById('selectedMood')?.value;
                if (!mood) {
                    UIUtil.showToast('စတင်ရန် လက်ရှိစိတ်ခံစားမှုကို ရွေးပေးပါ။', 'warning');
                    return;
                }
                
                this.journalMode = mode;
                this.resetPromptState();
                this.activePrompts = this.defaultPrompts[mode];
                this.promptAnswers = Array(this.activePrompts.length).fill('');
                
                this.renderView(templates.promptsSection, this.bindPromptButtons);
            }

            displayCurrentPrompt() {
                const progressBar = document.getElementById('progressBar');
                if(progressBar) {
                    const progress = ((this.currentPromptIndex + 1) / this.activePrompts.length) * 100;
                    progressBar.style.width = `${progress}%`;
                }

                document.getElementById('currentPromptText').textContent = this.activePrompts[this.currentPromptIndex];
                document.getElementById('promptAnswerTextarea').value = this.promptAnswers[this.currentPromptIndex] || '';
                document.getElementById('promptAnswerTextarea').focus();
                
                document.getElementById('promptCounter').textContent = `${this.currentPromptIndex + 1} / ${this.activePrompts.length}`;
                document.getElementById('prevPromptBtn').disabled = (this.currentPromptIndex === 0);
                const isLast = this.currentPromptIndex === this.activePrompts.length - 1;
                document.getElementById('nextPromptBtn').classList.toggle('hidden', isLast);
                document.getElementById('combineAnswersBtn').classList.toggle('hidden', !isLast);
            }

            navigatePrompt(direction) {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                const newIndex = this.currentPromptIndex + direction;
                if (newIndex >= 0 && newIndex < this.activePrompts.length) {
                    this.currentPromptIndex = newIndex;
                    this.displayCurrentPrompt();
                }
            }
            
            async combineAnswers() {
                this.promptAnswers[this.currentPromptIndex] = document.getElementById('promptAnswerTextarea').value.trim();
                 if (this.promptAnswers.every(answer => answer === '')) {
                    UIUtil.showToast('အကြံဉာဏ်ရယူရန် အနည်းဆုံး မေးခွန်းတစ်ခုကို ဖြေဆိုပေးပါ။', 'warning');
                    return;
                }
                
                const combineBtn = document.getElementById('combineAnswersBtn');
                UIUtil.setLoading(combineBtn, true, 'သုံးသပ်နေသည်');
                UIUtil.showToast('AI အကြံပြုချက် ရယူနေပါသည်။ ခေတ္တစောင့်ဆိုင်းပေးပါ။', 'info');

                const date = document.getElementById('journalDate').value;
                const mood = document.getElementById('selectedMood').value;
                const time = new Date().toLocaleTimeString('en-GB');

                const combinedAnswers = this.promptAnswers.map((answer, i) => 
                    answer ? `မေးခွန်း ${i + 1}: ${this.activePrompts[i]}\nအဖြေ: ${answer}` : ''
                ).filter(Boolean).join('\n\n---\n\n');
                
                this.fullJournalText = `ရက်စွဲ: ${date}\nအချိန်: ${time}\nစိတ်ခံစားမှု: ${mood}\nအမျိုးအစား: ${JournalApp.getPromptTitle(this.journalMode, false)}\n\n---\n\n${combinedAnswers}`;
                
                this.renderView(templates.analysisSection, () => {});
                document.getElementById('combinedJournalText').value = this.fullJournalText;

                try {
                    const advice = await GeminiAPI.fetchCounselorAdvice(combinedAnswers, mood, this.journalMode, this.apiKey, this.gender);
                    document.getElementById('aiSuggestionDisplay').textContent = advice;
                    
                    const newEntry = { date, time, mood, mode: this.journalMode, text: this.fullJournalText, aiSuggestion: advice };
                    this.journalEntries.push(newEntry);
                    StorageUtil.save('journalEntries', this.journalEntries);
                    
                    this.bindAnalysisSuccessButtons();
                } catch (error) {
                    document.getElementById('aiSuggestionDisplay').textContent = `တောင်းပန်ပါတယ်ရှင်။ ${error.message} ခဏနေပြီး 'ထပ်မံကြိုးစားမည်' ကို နှိပ်ကြည့်ပေးပါနော်။`;
                    this.bindAnalysisFailButtons();
                } finally {
                    UIUtil.setLoading(combineBtn, false, 'ပြီးပြီ');
                }
            }
            
            async summarizeJournals(entriesToSummarize) {
                if (entriesToSummarize.length === 0) {
                    UIUtil.showToast('အနှစ်ချုပ်ရန် မှတ်တမ်းများ မရှိသေးပါ။', 'warning');
                    return;
                }

                const summarizeBtn = document.getElementById('summarizeAllBtn');
                UIUtil.setLoading(summarizeBtn, true, '...');
                UIUtil.showToast('AI မှ မှတ်တမ်းများ အနှစ်ချုပ်နေပါသည်။ ခေတ္တစောင့်ဆိုင်းပေးပါ။', 'info');

                const allJournalTexts = entriesToSummarize.map(entry => {
                    return `ရက်စွဲ: ${entry.date}, စိတ်ခံစားမှု: ${entry.mood}\n${entry.text}`;
                }).join('\n\n---\n\n');

                const prompt = `You are a helpful assistant. Summarize the following collection of journal entries. Highlight key themes, recurring emotions, and overall progression. Provide a concise overview in Burmese.\n\nJournal Entries:\n${allJournalTexts}`;

                try {
                    const summary = await GeminiAPI.generateText(prompt, this.apiKey);
                    this.showSummary(entriesToSummarize);
                    document.getElementById('aiSummaryDisplay').textContent = summary;
                } catch (error) {
                    UIUtil.showToast(error.message, 'danger');
                } finally {
                    UIUtil.setLoading(summarizeBtn, false, '');
                }
            }

            async analyzeMoodTrends(entriesToAnalyze) {
                if (entriesToAnalyze.length < 2) {
                    UIUtil.showToast('စိတ်ခံစားမှု ခွဲခြမ်းစိတ်ဖြာရန် မှတ်တမ်းအနည်းဆုံး ၂ ခု လိုအပ်ပါသည်။', 'warning');
                    return;
                }

                const analyzeBtn = document.getElementById('analyzeMoodBtn');
                UIUtil.setLoading(analyzeBtn, true, '...');
                UIUtil.showToast('AI မှ စိတ်ခံစားမှုများကို ခွဲခြမ်းစိတ်ဖြာနေပါသည်။ ခေတ္တစောင့်ဆိုင်းပေးပါ။', 'info');

                const moodData = entriesToAnalyze.map(entry => {
                    return `ရက်စွဲ: ${entry.date}, စိတ်ခံစားမှု: ${entry.mood}, အကြောင်းအရာအကျဉ်း: ${entry.text.substring(0, 150)}...`;
                }).join('\n');

                const prompt = `You are an insightful assistant. Analyze the following journal entries to identify mood patterns, emotional shifts, or trends over time. Provide insights into what might be influencing these moods. Offer gentle reflections. Write the analysis in Burmese.\n\nJournal Entries:\n${moodData}`;

                try {
                    const analysis = await GeminiAPI.generateText(prompt, this.apiKey);
                    this.showMoodAnalysis(entriesToAnalyze);
                    document.getElementById('aiMoodAnalysisDisplay').textContent = analysis;
                } catch (error) {
                    UIUtil.showToast(error.message, 'danger');
                } finally {
                    UIUtil.setLoading(analyzeBtn, false, '');
                }
            }

            bindAnalysisSuccessButtons() {
                const actionsDiv = document.getElementById('analysis-actions');
                actionsDiv.innerHTML = `<button id="backToMainSuccessBtn" class="btn btn-primary">ပြီးပြီ</button>`;
                document.getElementById('backToMainSuccessBtn').onclick = () => this.showJournalSection();
            }

            bindAnalysisFailButtons() {
                const actionsDiv = document.getElementById('analysis-actions');
                actionsDiv.innerHTML = `
                    <button id="tryAgainBtn" class="btn btn-primary">ထပ်မံကြိုးစားမည်</button>
                    <button id="backToMainFailBtn" class="btn btn-outline-primary">ပင်မစာမျက်နှာသို့</button>
                `;
                document.getElementById('tryAgainBtn').onclick = () => this.combineAnswers();
                document.getElementById('backToMainFailBtn').onclick = () => this.showJournalSection();
            }
            
            showJournalEntryDetail(entry) {
                const modalEl = document.getElementById('entryDetailModal');
                if (!modalEl) return;
                const modal = new bootstrap.Modal(modalEl);
                document.getElementById('entryDetailTitle').textContent = `${entry.date} မှတ်တမ်း`;
                document.getElementById('entryDetailBody').innerHTML = `
                    <h5 class="fw-bold">AI အကြံပြုချက်</h5>
                    <p class="whitespace-pre-wrap p-2 rounded" style="background-color: #f0fff4;">${entry.aiSuggestion || 'AI အကြံပြုချက် မရှိပါ'}</p>
                    <hr>
                    <h5 class="fw-bold mt-3">သင်၏ မှတ်တမ်းအပြည့်အစုံ</h5>
                    <textarea class="form-control" rows="15" readonly>${entry.text}</textarea>
                `;
                modal.show();
            }

            static getPromptTitle(mode, withIcon = true) {
                const titles = {
                    morning: { icon: '🌅', text: 'မနက်ခင်း မှတ်တမ်း' },
                    night: { icon: '🌃', text: 'ညပိုင်း မှတ်တမ်း' },
                    gratitude: { icon: '🙏', text: 'ကျေးဇူးတင်ခြင်း' },
                    general: { icon: '💬', text: 'အထွေထွေ ရင်ဖွင့်ခြင်း' }
                };
                const selected = titles[mode] || { icon: '', text: 'မှတ်တမ်း' };
                return withIcon ? `${selected.icon} ${selected.text}` : selected.text;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new JournalApp();
        });
    </script>
</body>
</html>
